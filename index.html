<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ç–∏–≤ —Å—Ç. 333 –ì–ö –†–§</title>
    <link rel="icon" type="image/x-icon" href="/favicon-32.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1E3A5F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="333 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(145deg, #E8EEF2 0%, #D4DEE7 50%, #C5D3E0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #FAFBFC;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(30, 58, 95, 0.15);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1E3A5F 0%, #2C4A6E 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #C9A227, #E8C547, #C9A227);
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; }
        .header p { font-size: 14px; opacity: 0.85; }
        .stats-bar {
            background: #F4F7F9;
            padding: 8px 20px;
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #8899A6;
            border-bottom: 1px solid #E1E8ED;
        }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .stat-value { font-weight: 600; color: #1E3A5F; }
        .tabs-container {
            display: flex;
            background: #F4F7F9;
            border-bottom: 1px solid #E1E8ED;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .tabs-container::-webkit-scrollbar { display: none; }
        .main-tab {
            padding: 12px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 500;
            color: #4A5568;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .main-tab:hover { color: #1E3A5F; }
        .main-tab.active { color: #1E3A5F; border-bottom-color: #C9A227; background: #FAFBFC; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 600px;
        }
        .form-section {
            padding: 25px;
            background: #F4F7F9;
            border-right: 1px solid #E1E8ED;
            overflow-y: auto;
            max-height: 80vh;
        }
        .output-section {
            padding: 25px;
            background: #FAFBFC;
            overflow-y: auto;
            max-height: 80vh;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #C9A227;
        }
        .document-block {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .document-block h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 12px;
        }
        .document-block h3 .required { color: #C9A227; }
        .document-block h3 .optional { font-weight: 400; font-size: 11px; color: #8899A6; }
        .document-block h3 .file-limit { font-weight: 400; font-size: 11px; color: #8899A6; margin-left: 8px; }
        .input-tabs { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .tab-btn {
            padding: 6px 12px;
            border: 1px solid #E1E8ED;
            background: #F4F7F9;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            color: #4A5568;
        }
        .tab-btn.active { background: #1E3A5F; color: white; border-color: #1E3A5F; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-upload {
            border: 2px dashed #CBD5E0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #FAFBFC;
        }
        .file-upload:hover { border-color: #C9A227; background: #FFFDF5; }
        .file-upload.has-file { border-color: #48BB78; background: #F0FFF4; }
        .file-upload input[type="file"] { display: none; }
        .file-upload .upload-icon { font-size: 24px; margin-bottom: 8px; }
        .file-upload .upload-text { font-size: 12px; color: #8899A6; }
        .file-list { margin-top: 10px; }
        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #F4F7F9;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .file-item .file-preview {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            background: #E1E8ED;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .file-item .file-preview.clickable {
            cursor: pointer;
        }
        .file-item .file-preview.clickable:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .file-item .file-preview img { width: 100%; height: 100%; object-fit: cover; }
        .file-item .file-preview .zoom-hint {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .file-item .file-preview:hover .zoom-hint { opacity: 1; }
        /* Image preview modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }
        .image-preview-modal.active { display: flex; }
        .image-preview-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-preview-filename {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #1E3A5F;
        }
        .file-item .file-info { flex: 1; min-width: 0; }
        .file-item .file-name { font-size: 12px; color: #2D3748; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item .file-size { font-size: 10px; color: #8899A6; }
        .file-item .remove-file {
            color: #E53E3E;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 4px;
            background: none;
            border: none;
            opacity: 0.7;
            transition: opacity 0.2s, background 0.2s;
            flex-shrink: 0;
        }
        .file-item .remove-file:hover { opacity: 1; background: #FED7D7; }
        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 11px;
            color: #8899A6;
        }
        .clear-all-files {
            color: #E53E3E;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .clear-all-files:hover { background: #FED7D7; }
        .upload-buttons { display: flex; gap: 8px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
        .upload-btn {
            padding: 8px 16px;
            border: 1px solid #E1E8ED;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #4A5568;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .upload-btn:hover { background: #F4F7F9; border-color: #C9A227; }
        textarea, select, input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #E1E8ED;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 120px; }
        textarea:focus, select:focus, input:focus { outline: none; border-color: #C9A227; }
        .model-selector {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .model-selector h3 { font-size: 14px; font-weight: 600; color: #1E3A5F; margin-bottom: 12px; }
        .model-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .model-option {
            padding: 10px;
            border: 2px solid #E1E8ED;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
        }
        .model-option:hover { border-color: #C9A227; }
        .model-option.selected { border-color: #1E3A5F; background: #F0F5FF; }
        .model-option .model-name { font-weight: 600; font-size: 13px; color: #1E3A5F; }
        .model-option .model-desc { font-size: 11px; color: #8899A6; margin-top: 4px; }
        .rates-info {
            background: #F0F5FF;
            border: 1px solid #C3D4E8;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .rates-info h4 { font-size: 13px; color: #1E3A5F; margin-bottom: 8px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
        }
        .btn-primary { background: linear-gradient(135deg, #1E3A5F 0%, #2C4A6E 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #E8EEF2; color: #4A5568; }
        .btn-secondary:hover { background: #D4DEE7; }
        .btn-success { background: #48BB78; color: white; }
        .btn-warning { background: #ED8936; color: white; }
        .btn-info { background: #4299E1; color: white; }
        .btn-sm { padding: 8px 12px; font-size: 12px; }
        /* Progress Bar */
        .progress-container {
            display: none;
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .progress-container.active { display: block; }
        .progress-steps { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .progress-step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #E1E8ED;
        }
        .progress-step:last-child::after { display: none; }
        .progress-step .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #E1E8ED;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 1;
        }
        .progress-step.active .step-icon { background: #C9A227; color: white; }
        .progress-step.completed .step-icon { background: #48BB78; color: white; }
        .progress-step .step-label { font-size: 11px; color: #8899A6; margin-top: 8px; text-align: center; }
        .progress-step.active .step-label { color: #1E3A5F; font-weight: 600; }
        .progress-bar-track { height: 6px; background: #E1E8ED; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #C9A227, #E8C547); width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; font-size: 13px; color: #4A5568; margin-top: 10px; }
        .progress-time { text-align: center; font-size: 11px; color: #8899A6; margin-top: 5px; }
        /* Animated progress bar */
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(201, 162, 39, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(201, 162, 39, 0); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .progress-step.active .step-icon {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #C9A227 0%, #E8C547 25%, #C9A227 50%, #E8C547 75%, #C9A227 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        .progress-step::after {
            transition: background 0.3s ease;
        }
        .progress-step.completed::after {
            background: #48BB78 !important;
        }
        .progress-substep {
            font-size: 10px;
            color: #C9A227;
            margin-top: 4px;
            min-height: 14px;
        }
        .progress-details {
            background: #F4F7F9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 12px;
            font-size: 11px;
            color: #4A5568;
        }
        .progress-details-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .progress-details-item .label { color: #8899A6; }
        .progress-details-item .value { font-weight: 500; color: #1E3A5F; }
        .output-box {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            font-size: 14px;
            line-height: 1.7;
            color: #2D3748;
            white-space: pre-wrap;
        }
        .output-empty { color: #A0AEC0; font-style: italic; text-align: center; padding-top: 80px; }
        .output-editable:focus { outline: 2px solid #C9A227; }
        .model-badge {
            display: inline-block;
            background: #E8EEF2;
            color: #1E3A5F;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .time-badge {
            display: inline-block;
            background: #F0FFF4;
            color: #276749;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .action-buttons .btn { flex: 1; min-width: 100px; }
        .error-box {
            background: #FFF5F5;
            border: 1px solid #FC8181;
            border-radius: 8px;
            padding: 12px;
            color: #C53030;
            margin-bottom: 15px;
            display: none;
        }
        .error-box.active { display: block; }
        /* Comparison */
        .comparison-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E1E8ED;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }
        .comparison-select:focus { outline: none; border-color: #C9A227; }
        .comparison-container { display: none; grid-template-columns: 1fr 1fr; gap: 20px; }
        .comparison-container.active { display: grid; }
        .comparison-column { background: white; border: 1px solid #E1E8ED; border-radius: 8px; overflow: hidden; }
        .comparison-header { background: #F4F7F9; padding: 12px; border-bottom: 1px solid #E1E8ED; font-weight: 600; font-size: 13px; color: #1E3A5F; }
        .comparison-content { padding: 15px; max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap; }
        /* Calculator */
        .calculator-section { padding: 25px; }
        .calc-form { background: white; border: 1px solid #E1E8ED; border-radius: 8px; padding: 20px; max-width: 500px; }
        .calc-row { margin-bottom: 15px; }
        .calc-row label { display: block; font-size: 13px; font-weight: 500; color: #1E3A5F; margin-bottom: 6px; }
        .calc-result { background: #F0F5FF; border: 1px solid #C3D4E8; border-radius: 8px; padding: 20px; margin-top: 20px; }
        .calc-result h4 { font-size: 14px; color: #1E3A5F; margin-bottom: 15px; }
        .calc-result-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E1E8ED; }
        .calc-result-item:last-child { border-bottom: none; }
        .calc-result-item .label { color: #4A5568; }
        .calc-result-item .value { font-weight: 600; color: #1E3A5F; }
        .calc-result-item.total { font-size: 16px; }
        .calc-result-item.total .value { color: #C9A227; }
        /* Period rows */
        .period-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            padding: 10px;
            background: #F4F7F9;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .period-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #E1E8ED;
            border-radius: 4px;
            font-size: 12px;
        }
        .period-row label {
            font-size: 11px;
            color: #8899A6;
            margin-bottom: 4px;
            display: block;
        }
        .period-row .remove-period {
            background: none;
            border: none;
            color: #E53E3E;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
        }
        .period-row .remove-period:hover { background: #FED7D7; border-radius: 4px; }
        @media (max-width: 600px) {
            .period-row {
                grid-template-columns: 1fr 1fr;
            }
            .period-row > div:first-child {
                grid-column: span 2;
            }
        }
        /* Templates */
        .templates-section { padding: 25px; }
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .template-card { background: white; border: 1px solid #E1E8ED; border-radius: 8px; padding: 15px; cursor: pointer; }
        .template-card:hover { border-color: #C9A227; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .template-card h4 { font-size: 14px; color: #1E3A5F; margin-bottom: 8px; }
        .template-card p { font-size: 12px; color: #8899A6; line-height: 1.5; }
        .template-card .template-tags { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .template-tag { background: #F0F5FF; color: #1E3A5F; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        /* History */
        .history-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #E1E8ED; }
        .history-section h4 { font-size: 13px; color: #1E3A5F; margin-bottom: 10px; }
        .history-item {
            background: #F4F7F9;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            position: relative;
        }
        .history-item:hover { background: #E8EEF2; }
        .history-item .history-content { flex: 1; }
        .history-item .date { color: #8899A6; font-size: 11px; }
        .history-item .preview { color: #4A5568; margin-top: 4px; }
        .history-item .delete-history {
            color: #E53E3E;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            flex-shrink: 0;
        }
        .history-item:hover .delete-history { opacity: 1; }
        .history-item .delete-history:hover { background: #FED7D7; }
        .history-section .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-section .history-header h4 { margin: 0; }
        .history-section .clear-all-history {
            font-size: 11px;
            color: #E53E3E;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .history-section .clear-all-history:hover { background: #FED7D7; }
        .footer { background: #F4F7F9; padding: 12px; text-align: center; border-top: 1px solid #E1E8ED; }
        .footer .author { font-size: 11px; color: #8899A6; }
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #E1E8ED; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; color: #1E3A5F; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #8899A6; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid #E1E8ED; display: flex; gap: 10px; justify-content: flex-end; }
        @media (max-width: 968px) {
            .main-content { grid-template-columns: 1fr; }
            .form-section, .output-section { max-height: none; border-right: none; }
            .form-section { border-bottom: 1px solid #E1E8ED; }
            .model-options { grid-template-columns: 1fr; }
            .comparison-container { grid-template-columns: 1fr; }
            .stats-bar { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ç–∏–≤ —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–µ—É—Å—Ç–æ–π–∫–∏</h1>
            <p>–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Å—Ç. 333 –ì–ö –†–§</p>
        </div>

        <div class="stats-bar">
            <div class="stat-item">üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏–π: <span class="stat-value" id="totalGenerations">0</span></div>
            <div class="stat-item">‚è±Ô∏è –°—Ä. –≤—Ä–µ–º—è: <span class="stat-value" id="avgTime">-</span></div>
            <div class="stat-item">üèÜ –ü–æ–ø—É–ª—è—Ä–Ω–∞—è –º–æ–¥–µ–ª—å: <span class="stat-value" id="topModel">-</span></div>
        </div>

        <div class="tabs-container">
            <button class="main-tab active" onclick="switchMainTab('generator')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
            <button class="main-tab" onclick="switchMainTab('calculator')">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
            <button class="main-tab" onclick="switchMainTab('templates')">–®–∞–±–ª–æ–Ω—ã</button>
            <button class="main-tab" onclick="switchMainTab('comparison')">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
        </div>

        <!-- Generator Tab -->
        <div id="generator-panel" class="tab-panel active">
            <div class="main-content">
                <div class="form-section">
                    <h2 class="section-title">–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>

                    <div class="document-block">
                        <h3>–ò—Å–∫ –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –Ω–µ—É—Å—Ç–æ–π–∫–∏ <span class="required">*</span> <span class="file-limit">(–¥–æ 3 —Ñ–∞–π–ª–æ–≤)</span></h3>
                        <div class="input-tabs">
                            <button class="tab-btn active" onclick="switchTab('claim', 'file', this)">–§–∞–π–ª—ã</button>
                            <button class="tab-btn" onclick="switchTab('claim', 'text', this)">–¢–µ–∫—Å—Ç</button>
                        </div>
                        <div id="claim-file-tab" class="tab-content active">
                            <div class="file-upload" id="claim-upload-area">
                                <input type="file" id="claimFiles" multiple accept=".txt,.rtf,.docx,.doc,.pdf,.jpg,.jpeg,.png,.heic" onchange="handleMultiFileSelect(this, 'claim')">
                                <input type="file" id="claimCamera" accept="image/*" capture="environment" onchange="handleCameraCapture(this, 'claim')" style="display:none">
                                <div class="upload-icon">üìÑ</div>
                                <div class="upload-text">DOCX, PDF, TXT, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å. 10 –ú–ë)</div>
                            </div>
                            <div id="claim-file-list" class="file-list"></div>
                            <div class="upload-buttons">
                                <button type="button" class="upload-btn" onclick="document.getElementById('claimFiles').click()">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                                <button type="button" class="upload-btn" onclick="document.getElementById('claimCamera').click()">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                            </div>
                        </div>
                        <div id="claim-text-tab" class="tab-content">
                            <textarea id="claimText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏—Å–∫–∞..."></textarea>
                        </div>
                    </div>

                    <div class="document-block">
                        <h3>–û—Ç–∑—ã–≤ –æ—Ç–≤–µ—Ç—á–∏–∫–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span> <span class="file-limit">(–¥–æ 3 —Ñ–∞–π–ª–æ–≤)</span></h3>
                        <div class="input-tabs">
                            <button class="tab-btn active" onclick="switchTab('response', 'file', this)">–§–∞–π–ª—ã</button>
                            <button class="tab-btn" onclick="switchTab('response', 'text', this)">–¢–µ–∫—Å—Ç</button>
                        </div>
                        <div id="response-file-tab" class="tab-content active">
                            <div class="file-upload" id="response-upload-area">
                                <input type="file" id="responseFiles" multiple accept=".txt,.rtf,.docx,.doc,.pdf,.jpg,.jpeg,.png,.heic" onchange="handleMultiFileSelect(this, 'response')">
                                <input type="file" id="responseCamera" accept="image/*" capture="environment" onchange="handleCameraCapture(this, 'response')" style="display:none">
                                <div class="upload-icon">üìã</div>
                                <div class="upload-text">–•–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ —Å–Ω–∏–∂–µ–Ω–∏–∏</div>
                            </div>
                            <div id="response-file-list" class="file-list"></div>
                            <div class="upload-buttons">
                                <button type="button" class="upload-btn" onclick="document.getElementById('responseFiles').click()">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                                <button type="button" class="upload-btn" onclick="document.getElementById('responseCamera').click()">üì∑ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
                            </div>
                        </div>
                        <div id="response-text-tab" class="tab-content">
                            <textarea id="responseText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞..."></textarea>
                        </div>
                    </div>

                    <div class="document-block">
                        <h3>–ü–æ—è—Å–Ω–µ–Ω–∏—è <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></h3>
                        <textarea id="userComments" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∞–∫—Ü–µ–Ω—Ç—ã, –ø–æ–∂–µ–ª–∞–Ω–∏—è..." style="min-height: 80px;"></textarea>
                    </div>

                    <div class="model-selector">
                        <h3>–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏</h3>
                        <div class="model-options">
                            <div class="model-option selected" data-model="gemini-2.5-pro" onclick="selectModel(this)">
                                <div class="model-name">Gemini 2.5 Pro</div>
                                <div class="model-desc">Google, –±—ã—Å—Ç—Ä—ã–π</div>
                            </div>
                            <div class="model-option" data-model="claude-sonnet-4-20250514" onclick="selectModel(this)">
                                <div class="model-name">Claude Sonnet 4</div>
                                <div class="model-desc">Anthropic, –±–∞–ª–∞–Ω—Å</div>
                            </div>
                            <div class="model-option" data-model="claude-opus-4-5-20251101" onclick="selectModel(this)">
                                <div class="model-name">Claude Opus 4.5</div>
                                <div class="model-desc">Anthropic, –º–æ—â–Ω—ã–π</div>
                            </div>
                        </div>
                    </div>

                    <div class="rates-info">
                        <h4>üìä –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§</h4>
                        <div id="ratesContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>

                    <div class="button-group">
                        <button id="analyzeBtn" class="btn btn-primary" onclick="generateArguments()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-secondary" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>

                    <div class="history-section" id="historySection" style="display: none;">
                        <div class="history-header">
                            <h4>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h4>
                            <button class="clear-all-history" onclick="clearAllHistory()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                        </div>
                        <div id="historyList"></div>
                    </div>
                </div>

                <div class="output-section">
                    <h2 class="section-title">–ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–æ—Ç–∏–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç. 333 –ì–ö –†–§</h2>

                    <div id="progressContainer" class="progress-container">
                        <div class="progress-steps">
                            <div class="progress-step" data-step="1">
                                <div class="step-icon">üìÇ</div>
                                <div class="step-label">–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</div>
                                <div class="progress-substep" id="substep-1"></div>
                            </div>
                            <div class="progress-step" data-step="2">
                                <div class="step-icon">üîç</div>
                                <div class="step-label">OCR</div>
                                <div class="progress-substep" id="substep-2"></div>
                            </div>
                            <div class="progress-step" data-step="3">
                                <div class="step-icon">ü§ñ</div>
                                <div class="step-label">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
                                <div class="progress-substep" id="substep-3"></div>
                            </div>
                            <div class="progress-step" data-step="4">
                                <div class="step-icon">‚úÖ</div>
                                <div class="step-label">–ì–æ—Ç–æ–≤–æ</div>
                                <div class="progress-substep" id="substep-4"></div>
                            </div>
                        </div>
                        <div class="progress-bar-track"><div class="progress-bar-fill" id="progressFill"></div></div>
                        <div class="progress-text" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                        <div class="progress-time" id="progressTime"></div>
                        <div class="progress-details" id="progressDetails" style="display: none;">
                            <div class="progress-details-item">
                                <span class="label">–§–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</span>
                                <span class="value" id="filesProcessed">0 / 0</span>
                            </div>
                            <div class="progress-details-item">
                                <span class="label">–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:</span>
                                <span class="value" id="currentStage">-</span>
                            </div>
                        </div>
                    </div>

                    <div id="errorBox" class="error-box"></div>
                    <div id="outputBadges" style="display: none;"><span id="modelBadge" class="model-badge"></span><span id="timeBadge" class="time-badge"></span></div>
                    <div id="output" class="output-box output-empty" contenteditable="false">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª</div>

                    <div id="actionButtons" class="action-buttons" style="display: none;">
                        <button class="btn btn-secondary btn-sm" onclick="toggleEdit()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-primary btn-sm" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-success btn-sm" onclick="downloadDocx()">üì• DOCX</button>
                        <button class="btn btn-info btn-sm" onclick="downloadPdf()">üìï PDF</button>
                        <button class="btn btn-warning btn-sm" onclick="regenerateWithDifferentModel()">üîÑ –î—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å</button>
                        <button class="btn btn-secondary btn-sm" onclick="saveAsTemplate()">üíæ –®–∞–±–ª–æ–Ω</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator-panel" class="tab-panel">
            <div class="calculator-section">
                <h2 class="section-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–µ—É—Å—Ç–æ–π–∫–∏</h2>

                <div class="calc-form">
                    <div class="calc-row">
                        <label>–¢–∏–ø —Ä–∞—Å—á—ë—Ç–∞</label>
                        <select id="calcType" onchange="toggleCalcType()">
                            <option value="simple">–ü—Ä–æ—Å—Ç–æ–π (–æ–¥–Ω–∞ —Å—É–º–º–∞)</option>
                            <option value="periods">–ü–æ –ø–µ—Ä–∏–æ–¥–∞–º (–ø–æ—Å—Ç–∞–≤–∫–∏/–ø–ª–∞—Ç–µ–∂–∏)</option>
                        </select>
                    </div>

                    <!-- Simple calculation -->
                    <div id="simpleCalc">
                        <div class="calc-row"><label>–°—É–º–º–∞ –¥–æ–ª–≥–∞ (—Ä—É–±.)</label><input type="number" id="calcDebt" placeholder="1000000"></div>
                        <div class="calc-row"><label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏</label><input type="date" id="calcStartDate"></div>
                        <div class="calc-row"><label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—Ä–∞—Å—á—ë—Ç–∞)</label><input type="date" id="calcEndDate"></div>
                    </div>

                    <!-- Periods calculation -->
                    <div id="periodsCalc" style="display: none;">
                        <div class="calc-row">
                            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—Ä–∞—Å—á—ë—Ç–∞)</label>
                            <input type="date" id="calcEndDatePeriods">
                        </div>
                        <div style="margin: 15px 0;">
                            <label style="font-size: 13px; font-weight: 500; color: #1E3A5F;">–ü–æ—Å—Ç–∞–≤–∫–∏ / –ü–ª–∞—Ç–µ–∂–∏</label>
                            <p style="font-size: 11px; color: #8899A6; margin: 4px 0 10px;">–î–æ–±–∞–≤—å—Ç–µ —Å—É–º–º—ã –∏ —Å—Ä–æ–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤</p>
                        </div>
                        <div id="periodsList"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addPeriod()" style="margin-top: 10px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
                    </div>

                    <div class="calc-row" style="margin-top: 15px;">
                        <label>–°—Ç–∞–≤–∫–∞ –Ω–µ—É—Å—Ç–æ–π–∫–∏</label>
                        <select id="calcRateType" onchange="toggleCustomRate()">
                            <option value="contract">–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É (–≤–≤–µ—Å—Ç–∏)</option>
                            <option value="395">–°—Ç. 395 –ì–ö (–∫–ª—é—á. —Å—Ç–∞–≤–∫–∞)</option>
                            <option value="double">2x –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏</option>
                            <option value="01">0.1% –≤ –¥–µ–Ω—å</option>
                            <option value="05">0.5% –≤ –¥–µ–Ω—å</option>
                            <option value="1">1% –≤ –¥–µ–Ω—å</option>
                        </select>
                    </div>
                    <div class="calc-row" id="customRateRow"><label>–°—Ç–∞–≤–∫–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É (% –≥–æ–¥–æ–≤—ã—Ö)</label><input type="number" id="calcCustomRate" placeholder="36"></div>

                    <div id="calcError" style="display: none; background: #FFF5F5; border: 1px solid #FC8181; border-radius: 6px; padding: 10px; margin-top: 15px; color: #C53030; font-size: 13px;"></div>

                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="calculatePenalty()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                        <button class="btn btn-secondary" onclick="clearCalculator()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>

                    <div class="calc-result" id="calcResult" style="display: none;">
                        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞</h4>
                        <div id="calcResultDetails"></div>
                        <div class="calc-result-item total" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #C9A227;">
                            <span class="label">–ò—Ç–æ–≥–æ –Ω–µ—É—Å—Ç–æ–π–∫–∞</span>
                            <span class="value" id="resultPenalty">-</span>
                        </div>
                        <div class="calc-result-item">
                            <span class="label">–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ —Å—Ç. 333 (–¥–æ 2x –∫–ª—é—á.)</span>
                            <span class="value" id="result333">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Tab -->
        <div id="templates-panel" class="tab-panel">
            <div class="templates-section">
                <h2 class="section-title">–®–∞–±–ª–æ–Ω—ã –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤</h2>
                <p style="color: #8899A6; margin-bottom: 20px; font-size: 13px;">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–∏–ø–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π.</p>
                <div id="templateGrid" class="template-grid"></div>
                <div id="noTemplates" style="text-align: center; padding: 40px; color: #8899A6;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —É–¥–∞—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
            </div>
        </div>

        <!-- Comparison Tab -->
        <div id="comparison-panel" class="tab-panel">
            <div style="padding: 25px;">
                <h2 class="section-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
                <p style="color: #8899A6; margin-bottom: 20px; font-size: 13px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.</p>

                <div class="comparison-selectors" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 500; color: #1E3A5F; display: block; margin-bottom: 8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç 1</label>
                        <select id="compare1" class="comparison-select" onchange="updateComparisonPreview(1)">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 500; color: #1E3A5F; display: block; margin-bottom: 8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç 2</label>
                        <select id="compare2" class="comparison-select" onchange="updateComparisonPreview(2)">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="runHistoryComparison()" id="compareBtn">–°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>

                <div id="noHistoryMessage" style="text-align: center; padding: 40px; color: #8899A6; display: none;">
                    –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä".
                </div>

                <div id="comparisonContainer" class="comparison-container" style="margin-top: 20px;">
                    <div class="comparison-column">
                        <div class="comparison-header" id="header-1">–†–µ–∑—É–ª—å—Ç–∞—Ç 1</div>
                        <div class="comparison-content" id="content-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</div>
                    </div>
                    <div class="comparison-column">
                        <div class="comparison-header" id="header-2">–†–µ–∑—É–ª—å—Ç–∞—Ç 2</div>
                        <div class="comparison-content" id="content-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer"><div class="author">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ö–∏—Ä–∏–ª–ª –¢—Ä—É–±–∏—Ü—ã–Ω</div></div>
    </div>

    <!-- Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</h3><button class="modal-close" onclick="closeTemplateModal()">√ó</button></div>
            <div class="modal-body">
                <div class="calc-row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label><input type="text" id="templateName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ—Å—Ç–∞–≤–∫–∏"></div>
                <div class="calc-row"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="templateDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." style="min-height: 60px;"></textarea></div>
                <div class="calc-row"><label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" id="templateTags" placeholder="–ø–æ—Å—Ç–∞–≤–∫–∞, —Ç–æ–≤–∞—Ä, 333"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeTemplateModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="confirmSaveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="closeImagePreview()">
        <button class="image-preview-close" onclick="closeImagePreview()">√ó</button>
        <img id="imagePreviewImg" src="" alt="Preview">
        <div class="image-preview-filename" id="imagePreviewFilename"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const MAX_FILES = 3, MAX_FILE_SIZE = 10 * 1024 * 1024;
        const MODEL_NAMES = {'gemini-2.5-pro': 'Gemini 2.5 Pro', 'claude-sonnet-4-20250514': 'Claude Sonnet 4', 'claude-opus-4-5-20251101': 'Claude Opus 4.5'};

        let cachedRates = [], currentRate = null, lastResult = '', selectedModel = 'gemini-2.5-pro', lastUsedModel = '', lastInputData = null;
        let claimFiles = [], responseFiles = [], isEditing = false, generationStartTime = null;
        let stats = JSON.parse(localStorage.getItem('generationStats') || '{"total":0,"times":[],"models":{}}');

        document.addEventListener('DOMContentLoaded', () => {
            loadRates(); loadHistory(); loadTemplates(); updateStats(); loadDraft(); loadComparisonSelectors();
            setInterval(saveDraft, 30000);
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('calcEndDate').value = today;
            document.getElementById('calcEndDatePeriods').value = today;
        });

        function switchMainTab(tabName) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.main-tab[onclick="switchMainTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
        }

        function selectModel(el) {
            document.querySelectorAll('.model-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedModel = el.dataset.model;
        }

        async function loadRates() {
            try {
                const response = await fetch('/api/rates');
                if (response.ok) {
                    const data = await response.json();
                    cachedRates = data.history || [];
                    currentRate = data.current;
                    if (currentRate) {
                        document.getElementById('ratesContainer').innerHTML = `<div style="font-size: 24px; font-weight: 700; color: #1E3A5F;">${currentRate.key_rate}%</div><div style="font-size: 11px; color: #8899A6;">—Å ${formatDate(currentRate.date_from)}</div>`;
                    }
                }
            } catch (e) { document.getElementById('ratesContainer').innerHTML = '<div style="color: #C53030;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
        }

        function formatDate(d) { return new Date(d).toLocaleDateString('ru-RU'); }

        function switchTab(docType, tabType, btn) {
            btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`${docType}-file-tab`).classList.remove('active');
            document.getElementById(`${docType}-text-tab`).classList.remove('active');
            document.getElementById(`${docType}-${tabType}-tab`).classList.add('active');
        }

        function handleMultiFileSelect(input, docType) {
            const files = Array.from(input.files);
            const currentFiles = docType === 'claim' ? claimFiles : responseFiles;
            for (const file of files) {
                if (currentFiles.length >= MAX_FILES) { alert(`–ú–∞–∫—Å–∏–º—É–º ${MAX_FILES} —Ñ–∞–π–ª–∞`); break; }
                if (file.size > MAX_FILE_SIZE) { alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)`); continue; }
                if (docType === 'claim') claimFiles.push(file); else responseFiles.push(file);
            }
            updateFileList(docType);
            input.value = '';
        }

        function handleCameraCapture(input, docType) {
            if (input.files && input.files[0]) {
                const currentFiles = docType === 'claim' ? claimFiles : responseFiles;
                if (currentFiles.length >= MAX_FILES) { alert(`–ú–∞–∫—Å–∏–º—É–º ${MAX_FILES} —Ñ–∞–π–ª–∞`); return; }
                const file = input.files[0];
                if (file.size > MAX_FILE_SIZE) { alert(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π`); return; }
                if (docType === 'claim') claimFiles.push(file); else responseFiles.push(file);
                updateFileList(docType);
            }
            input.value = '';
        }

        function removeFile(docType, index) {
            if (docType === 'claim') claimFiles.splice(index, 1); else responseFiles.splice(index, 1);
            updateFileList(docType);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' –ë';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' –ö–ë';
            return (bytes / (1024 * 1024)).toFixed(1) + ' –ú–ë';
        }

        function updateFileList(docType) {
            const files = docType === 'claim' ? claimFiles : responseFiles;
            const listEl = document.getElementById(`${docType}-file-list`);
            const uploadArea = document.getElementById(`${docType}-upload-area`);
            if (files.length === 0) {
                listEl.innerHTML = '';
                uploadArea.classList.remove('has-file');
            } else {
                const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                const header = `
                    <div class="file-list-header">
                        <span>${files.length} —Ñ–∞–π–ª(–æ–≤), ${formatFileSize(totalSize)}</span>
                        <button class="clear-all-files" onclick="clearAllFiles('${docType}')">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                    </div>
                `;
                const items = files.map((file, i) => {
                    const isImage = file.type.startsWith('image/');
                    const objectUrl = isImage ? URL.createObjectURL(file) : '';
                    const preview = isImage
                        ? `<img src="${objectUrl}"><span class="zoom-hint">üîç</span>`
                        : getFileIcon(file.name);
                    const clickHandler = isImage
                        ? `onclick="openImagePreview('${objectUrl}', '${file.name.replace(/'/g, "\\'")}'); event.stopPropagation();"`
                        : '';
                    const clickableClass = isImage ? 'clickable' : '';
                    return `<div class="file-item"><div class="file-preview ${clickableClass}" ${clickHandler}>${preview}</div><div class="file-info"><div class="file-name" title="${file.name}">${file.name}</div><div class="file-size">${formatFileSize(file.size)}</div></div><button class="remove-file" onclick="removeFile('${docType}', ${i})" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">‚úï</button></div>`;
                }).join('');
                listEl.innerHTML = header + items;
                uploadArea.classList.add('has-file');
            }
        }

        function clearAllFiles(docType) {
            if (docType === 'claim') {
                claimFiles = [];
            } else {
                responseFiles = [];
            }
            updateFileList(docType);
        }

        function openImagePreview(src, filename) {
            document.getElementById('imagePreviewImg').src = src;
            document.getElementById('imagePreviewFilename').textContent = filename;
            document.getElementById('imagePreviewModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            if (['jpg', 'jpeg', 'png', 'heic'].includes(ext)) return 'üñºÔ∏è';
            if (ext === 'pdf') return 'üìï';
            if (['doc', 'docx'].includes(ext)) return 'üìò';
            return 'üìÑ';
        }

        async function readFileContent(file, statusCallback) {
            const ext = file.name.toLowerCase().split('.').pop();
            if (ext === 'docx' || ext === 'doc') { if (statusCallback) statusCallback(`–ß–∏—Ç–∞—é ${file.name}...`); return await readDocx(file); }
            if (ext === 'pdf') { if (statusCallback) statusCallback(`–ò–∑–≤–ª–µ–∫–∞—é —Ç–µ–∫—Å—Ç –∏–∑ ${file.name}...`); return await readPdf(file); }
            if (['jpg', 'jpeg', 'png', 'heic'].includes(ext)) { if (statusCallback) statusCallback(`–†–∞—Å–ø–æ–∑–Ω–∞—é —Ç–µ–∫—Å—Ç –Ω–∞ ${file.name}...`); return await recognizeImage(file); }
            return await readTextFile(file);
        }

        async function readDocx(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => { try { resolve((await mammoth.extractRawText({ arrayBuffer: e.target.result })).value); } catch (err) { reject(err); } };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function readPdf(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                        let text = '';
                        for (let i = 1; i <= pdf.numPages; i++) { const page = await pdf.getPage(i); const content = await page.getTextContent(); text += content.items.map(item => item.str).join(' ') + '\n\n'; }
                        resolve(text.trim());
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function readTextFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = reject; reader.readAsText(file, 'UTF-8'); }); }

        async function recognizeImage(file) {
            let imageData = await fileToBase64(file);
            if (file.size > 2 * 1024 * 1024) imageData = await compressImage(imageData);
            const response = await fetch('/api/ocr', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: imageData, filename: file.name }) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞ OCR');
            return result.text;
        }

        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); }

        async function compressImage(base64) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 1600;
                    let { width, height } = img;
                    if (width > height && width > maxSize) { height = (height * maxSize) / width; width = maxSize; } else if (height > maxSize) { width = (width * maxSize) / height; height = maxSize; }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                img.src = 'data:image/jpeg;base64,' + base64;
            });
        }

        let progressState = { totalFiles: 0, processedFiles: 0, currentFile: '' };

        function setProgress(step, percent, text, substepText = '', details = {}) {
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;

            // Update steps visualization
            document.querySelectorAll('.progress-step').forEach(el => {
                const stepNum = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (stepNum < step) el.classList.add('completed');
                if (stepNum === step) el.classList.add('active');
            });

            // Update substep text
            for (let i = 1; i <= 4; i++) {
                const substepEl = document.getElementById(`substep-${i}`);
                if (substepEl) substepEl.textContent = i === step ? substepText : '';
            }

            // Update elapsed time
            if (generationStartTime) {
                document.getElementById('progressTime').textContent = `–ü—Ä–æ—à–ª–æ: ${((Date.now() - generationStartTime) / 1000).toFixed(1)} —Å–µ–∫.`;
            }

            // Update progress details
            const detailsEl = document.getElementById('progressDetails');
            if (details.showDetails) {
                detailsEl.style.display = 'block';
                if (details.filesTotal !== undefined) {
                    document.getElementById('filesProcessed').textContent = `${details.filesProcessed || 0} / ${details.filesTotal}`;
                }
                if (details.stage) {
                    document.getElementById('currentStage').textContent = details.stage;
                }
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('progressDetails').style.display = 'none';
            for (let i = 1; i <= 4; i++) {
                const substepEl = document.getElementById(`substep-${i}`);
                if (substepEl) substepEl.textContent = '';
            }
        }

        async function processAllFiles(files, statusCallback) {
            const texts = [];
            for (const file of files) { try { const text = await readFileContent(file, statusCallback); if (text && text.trim()) texts.push(`--- ${file.name} ---\n${text}`); } catch (err) { texts.push(`--- ${file.name} ---\n[–û—à–∏–±–∫–∞: ${err.message}]`); } }
            return texts.join('\n\n');
        }

        async function generateArguments(useModel = null) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorBox');
            const actionButtons = document.getElementById('actionButtons');
            const outputBadges = document.getElementById('outputBadges');
            const modelToUse = useModel || selectedModel;
            generationStartTime = Date.now();

            let finalClaimText = document.getElementById('claimText').value;
            let finalResponseText = document.getElementById('responseText').value;
            const userComments = document.getElementById('userComments').value;

            analyzeBtn.disabled = true;
            output.style.display = 'none';
            errorBox.classList.remove('active');
            actionButtons.style.display = 'none';
            outputBadges.style.display = 'none';

            try {
                const totalFiles = claimFiles.length + responseFiles.length;
                let processedFiles = 0;
                const hasImages = [...claimFiles, ...responseFiles].some(f => f.type.startsWith('image/'));

                // Step 1: Reading files
                setProgress(1, 5, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —á—Ç–µ–Ω–∏—é —Ñ–∞–π–ª–æ–≤...', '', { showDetails: totalFiles > 0, filesTotal: totalFiles, filesProcessed: 0, stage: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è' });

                if (claimFiles.length > 0) {
                    for (let i = 0; i < claimFiles.length; i++) {
                        const file = claimFiles[i];
                        const isImage = file.type.startsWith('image/');
                        const stepNum = isImage ? 2 : 1;
                        const stepLabel = isImage ? 'OCR' : '–ß—Ç–µ–Ω–∏–µ';
                        const progress = 5 + ((i + 1) / totalFiles) * 35;

                        setProgress(stepNum, progress, `${stepLabel}: ${file.name}`, file.name.substring(0, 20) + (file.name.length > 20 ? '...' : ''), {
                            showDetails: true,
                            filesTotal: totalFiles,
                            filesProcessed: processedFiles,
                            stage: isImage ? '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)' : '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞'
                        });

                        try {
                            const text = await readFileContent(file, null);
                            if (text && text.trim()) finalClaimText += `\n\n--- ${file.name} ---\n${text}`;
                        } catch (err) {
                            finalClaimText += `\n\n--- ${file.name} ---\n[–û—à–∏–±–∫–∞: ${err.message}]`;
                        }
                        processedFiles++;
                    }
                }

                if (responseFiles.length > 0) {
                    for (let i = 0; i < responseFiles.length; i++) {
                        const file = responseFiles[i];
                        const isImage = file.type.startsWith('image/');
                        const stepNum = isImage ? 2 : 1;
                        const stepLabel = isImage ? 'OCR' : '–ß—Ç–µ–Ω–∏–µ';
                        const progress = 40 + ((i + 1) / responseFiles.length) * 15;

                        setProgress(stepNum, progress, `${stepLabel} –æ—Ç–∑—ã–≤–∞: ${file.name}`, file.name.substring(0, 20) + (file.name.length > 20 ? '...' : ''), {
                            showDetails: true,
                            filesTotal: totalFiles,
                            filesProcessed: processedFiles,
                            stage: isImage ? '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)' : '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞'
                        });

                        try {
                            const text = await readFileContent(file, null);
                            if (text && text.trim()) finalResponseText += `\n\n--- ${file.name} ---\n${text}`;
                        } catch (err) {
                            finalResponseText += `\n\n--- ${file.name} ---\n[–û—à–∏–±–∫–∞: ${err.message}]`;
                        }
                        processedFiles++;
                    }
                }

                if (!finalClaimText.trim()) throw new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å–∫ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ —Ç–µ–∫—Å—Ç');

                lastInputData = { claim_text: finalClaimText, response_text: finalResponseText, user_comments: userComments };

                // Step 3: AI Generation
                setProgress(3, 60, `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤...`, MODEL_NAMES[modelToUse], {
                    showDetails: true,
                    filesTotal: totalFiles,
                    filesProcessed: processedFiles,
                    stage: `–ú–æ–¥–µ–ª—å: ${MODEL_NAMES[modelToUse]}`
                });

                const ratesInfo = currentRate ? `–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§: ${currentRate.key_rate}% (—Å ${currentRate.date_from})` : '';
                const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ claim_text: finalClaimText, response_text: finalResponseText, other_documents: '', user_comments: userComments, rates_info: ratesInfo, model: modelToUse }) });

                setProgress(3, 85, '–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI...', '–û–±—Ä–∞–±–æ—Ç–∫–∞', { showDetails: true, filesTotal: totalFiles, filesProcessed: processedFiles, stage: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞');

                setProgress(4, 100, '–ì–æ—Ç–æ–≤–æ!', '–£—Å–ø–µ—à–Ω–æ', { showDetails: false });
                const generationTime = ((Date.now() - generationStartTime) / 1000).toFixed(1);

                setTimeout(() => {
                    hideProgress();
                    lastResult = result.arguments_text;
                    lastUsedModel = result.model_used || modelToUse;
                    document.getElementById('modelBadge').textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                    document.getElementById('timeBadge').textContent = `‚è±Ô∏è ${generationTime} —Å–µ–∫.`;
                    outputBadges.style.display = 'block';
                    output.textContent = result.arguments_text;
                    output.classList.remove('output-empty');
                    output.style.display = 'block';
                    actionButtons.style.display = 'flex';
                    saveToHistory(result.arguments_text, lastUsedModel);
                    updateStatsAfterGeneration(lastUsedModel, parseFloat(generationTime));
                }, 500);
            } catch (error) { hideProgress(); errorBox.textContent = '‚ùå ' + error.message; errorBox.classList.add('active'); output.style.display = 'block'; } finally { analyzeBtn.disabled = false; }
        }

        function regenerateWithDifferentModel() {
            if (!lastInputData) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã'); return; }
            const models = ['gemini-2.5-pro', 'claude-sonnet-4-20250514', 'claude-opus-4-5-20251101'];
            const nextModel = models[(models.indexOf(lastUsedModel) + 1) % models.length];
            document.querySelectorAll('.model-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.model === nextModel));
            selectedModel = nextModel;
            generateWithSavedData(nextModel);
        }

        async function generateWithSavedData(modelToUse) {
            if (!lastInputData) return;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorBox');
            const actionButtons = document.getElementById('actionButtons');
            const outputBadges = document.getElementById('outputBadges');

            analyzeBtn.disabled = true;
            generationStartTime = Date.now();
            setProgress(3, 30, `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è (${MODEL_NAMES[modelToUse]})...`);
            output.style.display = 'none';
            errorBox.classList.remove('active');
            actionButtons.style.display = 'none';

            try {
                const ratesInfo = currentRate ? `–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§: ${currentRate.key_rate}%` : '';
                const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...lastInputData, other_documents: '', rates_info: ratesInfo, model: modelToUse }) });
                setProgress(3, 80, '–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...', MODEL_NAMES[modelToUse], { showDetails: true, filesTotal: 0, filesProcessed: 0, stage: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞');

                setProgress(4, 100, '–ì–æ—Ç–æ–≤–æ!', '–£—Å–ø–µ—à–Ω–æ', { showDetails: false });
                const generationTime = ((Date.now() - generationStartTime) / 1000).toFixed(1);
                setTimeout(() => {
                    hideProgress();
                    lastResult = result.arguments_text;
                    lastUsedModel = result.model_used || modelToUse;
                    document.getElementById('modelBadge').textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                    document.getElementById('timeBadge').textContent = `‚è±Ô∏è ${generationTime} —Å–µ–∫.`;
                    outputBadges.style.display = 'block';
                    output.textContent = result.arguments_text;
                    output.classList.remove('output-empty');
                    output.style.display = 'block';
                    actionButtons.style.display = 'flex';
                    saveToHistory(result.arguments_text, lastUsedModel);
                    updateStatsAfterGeneration(lastUsedModel, parseFloat(generationTime));
                }, 500);
            } catch (error) { hideProgress(); errorBox.textContent = '‚ùå ' + error.message; errorBox.classList.add('active'); output.style.display = 'block'; } finally { analyzeBtn.disabled = false; }
        }

        // Comparison functions - compare results from history
        function loadComparisonSelectors() {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const select1 = document.getElementById('compare1');
            const select2 = document.getElementById('compare2');
            const noHistoryMsg = document.getElementById('noHistoryMessage');
            const container = document.getElementById('comparisonContainer');

            if (history.length < 2) {
                noHistoryMsg.style.display = 'block';
                container.classList.remove('active');
                select1.innerHTML = '<option value="">-- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ --</option>';
                select2.innerHTML = '<option value="">-- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ --</option>';
                return;
            }

            noHistoryMsg.style.display = 'none';

            const options = history.map((item, i) => {
                const date = formatDate(item.date);
                const model = item.model ? (MODEL_NAMES[item.model] || item.model) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const preview = item.preview.substring(0, 50) + '...';
                return `<option value="${i}">${date} - ${model}: ${preview}</option>`;
            }).join('');

            select1.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>' + options;
            select2.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>' + options;
        }

        function updateComparisonPreview(num) {
            const select = document.getElementById(`compare${num}`);
            const index = select.value;
            const header = document.getElementById(`header-${num}`);
            const content = document.getElementById(`content-${num}`);

            if (index === '') {
                header.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç ${num}`;
                content.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ';
                return;
            }

            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const item = history[index];
            if (item) {
                const model = item.model ? (MODEL_NAMES[item.model] || item.model) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                header.textContent = `${formatDate(item.date)} - ${model}`;
                content.textContent = item.text;
            }
        }

        function runHistoryComparison() {
            const index1 = document.getElementById('compare1').value;
            const index2 = document.getElementById('compare2').value;

            if (index1 === '' || index2 === '') {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
                return;
            }

            if (index1 === index2) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
                return;
            }

            document.getElementById('comparisonContainer').classList.add('active');
            updateComparisonPreview(1);
            updateComparisonPreview(2);
        }

        function toggleEdit() {
            const output = document.getElementById('output');
            isEditing = !isEditing;
            output.contentEditable = isEditing;
            output.classList.toggle('output-editable', isEditing);
            if (isEditing) output.focus(); else lastResult = output.textContent;
        }

        function clearForm() {
            claimFiles = []; responseFiles = [];
            updateFileList('claim'); updateFileList('response');
            ['claimText', 'responseText', 'userComments'].forEach(id => document.getElementById(id).value = '');
            const output = document.getElementById('output');
            output.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª';
            output.classList.add('output-empty');
            output.contentEditable = false;
            isEditing = false;
            document.getElementById('errorBox').classList.remove('active');
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('outputBadges').style.display = 'none';
            lastInputData = null;
            localStorage.removeItem('draft');
        }

        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('output').textContent).then(() => alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')); }

        async function downloadDocx() {
            const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx;
            const text = document.getElementById('output').textContent;
            const lines = text.split('\n');
            const children = [];
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) { children.push(new Paragraph({ text: '' })); continue; }
                const isMainHeading = /^\d+\.\s+[–ê-–Ø–ÅA-Z\s]+$/.test(trimmed);
                const isSubHeading = /^\d+\.\d+\.?\s+/.test(trimmed);
                if (isMainHeading) children.push(new Paragraph({ children: [new TextRun({ text: trimmed, bold: true, size: 26, color: "1a3a6e" })], spacing: { before: 360, after: 180 } }));
                else if (isSubHeading) children.push(new Paragraph({ children: [new TextRun({ text: trimmed, bold: true, size: 24, color: "1a3a6e" })], spacing: { before: 240, after: 120 } }));
                else children.push(new Paragraph({ children: [new TextRun({ text: trimmed, size: 24 })], spacing: { after: 120 }, alignment: AlignmentType.JUSTIFIED }));
            }
            const doc = new Document({ sections: [{ properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } }, children }] });
            saveAs(await Packer.toBlob(doc), 'arguments_333.docx');
        }

        async function downloadPdf() {
            const { jsPDF } = window.jspdf;
            const outputEl = document.getElementById('output');
            const text = outputEl.textContent;

            // Create a temporary container for PDF rendering
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `
                position: absolute;
                left: -9999px;
                top: 0;
                width: 550px;
                padding: 30px;
                background: white;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 11px;
                line-height: 1.5;
                color: #000;
                white-space: pre-wrap;
                word-wrap: break-word;
            `;
            tempDiv.textContent = text;
            document.body.appendChild(tempDiv);

            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            const pageWidthMm = pdf.internal.pageSize.getWidth();
            const pageHeightMm = pdf.internal.pageSize.getHeight();
            const marginMm = 10;
            const contentWidthMm = pageWidthMm - marginMm * 2;
            const contentHeightMm = pageHeightMm - marginMm * 2;

            try {
                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Calculate how much canvas height fits on one page
                const pxPerMm = canvas.width / contentWidthMm;
                const pageHeightPx = contentHeightMm * pxPerMm;
                const totalPages = Math.ceil(canvas.height / pageHeightPx);

                for (let page = 0; page < totalPages; page++) {
                    if (page > 0) pdf.addPage();

                    // Calculate source coordinates for this page slice
                    const srcY = page * pageHeightPx;
                    const srcHeight = Math.min(pageHeightPx, canvas.height - srcY);

                    // Create a cropped canvas for this page
                    const pageCanvas = document.createElement('canvas');
                    pageCanvas.width = canvas.width;
                    pageCanvas.height = srcHeight;
                    const ctx = pageCanvas.getContext('2d');
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);
                    ctx.drawImage(canvas, 0, srcY, canvas.width, srcHeight, 0, 0, canvas.width, srcHeight);

                    const pageImgData = pageCanvas.toDataURL('image/jpeg', 0.92);
                    const imgHeightMm = srcHeight / pxPerMm;
                    pdf.addImage(pageImgData, 'JPEG', marginMm, marginMm, contentWidthMm, imgHeightMm);
                }

                pdf.save('arguments_333.pdf');
            } finally {
                document.body.removeChild(tempDiv);
            }
        }

        function saveToHistory(fullText, model) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            history.unshift({ date: new Date().toISOString(), preview: fullText.substring(0, 100).replace(/[\r\n]+/g, ' '), text: fullText, model });
            if (history.length > 10) history.pop();
            localStorage.setItem('argumentsHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                section.style.display = 'none';
                loadComparisonSelectors();
                return;
            }
            section.style.display = 'block';
            list.innerHTML = history.map((item, i) => `
                <div class="history-item">
                    <div class="history-content" onclick="loadFromHistory(${i})">
                        <div class="date">${formatDate(item.date)} ${item.model ? '‚Ä¢ ' + (MODEL_NAMES[item.model] || item.model) : ''}</div>
                        <div class="preview">${item.preview}...</div>
                    </div>
                    <button class="delete-history" onclick="event.stopPropagation(); deleteFromHistory(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                </div>
            `).join('');
            loadComparisonSelectors();
        }

        function deleteFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            if (index >= 0 && index < history.length) {
                history.splice(index, 1);
                localStorage.setItem('argumentsHistory', JSON.stringify(history));
                loadHistory();
            }
        }

        function clearAllHistory() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤?')) {
                localStorage.removeItem('argumentsHistory');
                loadHistory();
            }
        }

        function loadFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            if (history[index]) {
                lastResult = history[index].text;
                lastUsedModel = history[index].model || '';
                const output = document.getElementById('output');
                output.textContent = history[index].text;
                output.classList.remove('output-empty');
                output.style.display = 'block';
                document.getElementById('actionButtons').style.display = 'flex';
                if (lastUsedModel) { document.getElementById('modelBadge').textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel; document.getElementById('outputBadges').style.display = 'block'; }
            }
        }

        function loadTemplates() {
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            const grid = document.getElementById('templateGrid');
            const noTemplates = document.getElementById('noTemplates');
            if (templates.length === 0) { grid.innerHTML = ''; noTemplates.style.display = 'block'; return; }
            noTemplates.style.display = 'none';
            grid.innerHTML = templates.map((t, i) => `<div class="template-card" onclick="useTemplate(${i})"><h4>${t.name}</h4><p>${t.description}</p><div class="template-tags">${t.tags.map(tag => `<span class="template-tag">${tag}</span>`).join('')}</div><button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="event.stopPropagation(); deleteTemplate(${i})">–£–¥–∞–ª–∏—Ç—å</button></div>`).join('');
        }

        function saveAsTemplate() { if (!lastResult) { alert('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞'); return; } document.getElementById('templateModal').classList.add('active'); }
        function closeTemplateModal() { document.getElementById('templateModal').classList.remove('active'); document.getElementById('templateName').value = ''; document.getElementById('templateDesc').value = ''; document.getElementById('templateTags').value = ''; }

        function confirmSaveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            templates.push({ name, description: document.getElementById('templateDesc').value.trim(), tags: document.getElementById('templateTags').value.trim().split(',').map(t => t.trim()).filter(t => t), text: lastResult, model: lastUsedModel, date: new Date().toISOString() });
            localStorage.setItem('argumentTemplates', JSON.stringify(templates));
            closeTemplateModal(); loadTemplates(); alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
        }

        function useTemplate(index) {
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            if (templates[index]) {
                lastResult = templates[index].text;
                lastUsedModel = templates[index].model;
                switchMainTab('generator');
                const output = document.getElementById('output');
                output.textContent = templates[index].text;
                output.classList.remove('output-empty');
                output.style.display = 'block';
                document.getElementById('actionButtons').style.display = 'flex';
                document.getElementById('modelBadge').textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                document.getElementById('outputBadges').style.display = 'block';
            }
        }

        function deleteTemplate(index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) return;
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            templates.splice(index, 1);
            localStorage.setItem('argumentTemplates', JSON.stringify(templates));
            loadTemplates();
        }

        let calcPeriods = [];

        function toggleCalcType() {
            const calcType = document.getElementById('calcType').value;
            document.getElementById('simpleCalc').style.display = calcType === 'simple' ? 'block' : 'none';
            document.getElementById('periodsCalc').style.display = calcType === 'periods' ? 'block' : 'none';
            if (calcType === 'periods' && calcPeriods.length === 0) {
                addPeriod();
            }
        }

        function addPeriod() {
            const id = Date.now();
            calcPeriods.push(id);
            const periodsList = document.getElementById('periodsList');
            const div = document.createElement('div');
            div.className = 'period-row';
            div.id = `period-${id}`;
            div.innerHTML = `
                <div>
                    <label>–°—É–º–º–∞ (—Ä—É–±.)</label>
                    <input type="number" id="period-amount-${id}" placeholder="100000">
                </div>
                <div>
                    <label>–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="date" id="period-due-${id}">
                </div>
                <div>
                    <label>–î–∞—Ç–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="date" id="period-done-${id}" placeholder="–µ—Å–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–æ">
                </div>
                <button type="button" class="remove-period" onclick="removePeriod(${id})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
            `;
            periodsList.appendChild(div);
        }

        function removePeriod(id) {
            calcPeriods = calcPeriods.filter(p => p !== id);
            const el = document.getElementById(`period-${id}`);
            if (el) el.remove();
        }

        function getRate() {
            const rateType = document.getElementById('calcRateType').value;
            const keyRate = currentRate ? currentRate.key_rate : 21;
            let yearRate, rateLabel;

            switch (rateType) {
                case '395': yearRate = keyRate; rateLabel = `${yearRate}% (–∫–ª—é—á. —Å—Ç–∞–≤–∫–∞)`; break;
                case 'double': yearRate = keyRate * 2; rateLabel = `${yearRate}% (2x –∫–ª—é—á. —Å—Ç–∞–≤–∫–∏)`; break;
                case '01': yearRate = 36.5; rateLabel = '0.1% –≤ –¥–µ–Ω—å'; break;
                case '05': yearRate = 182.5; rateLabel = '0.5% –≤ –¥–µ–Ω—å'; break;
                case '1': yearRate = 365; rateLabel = '1% –≤ –¥–µ–Ω—å'; break;
                default:
                    yearRate = parseFloat(document.getElementById('calcCustomRate').value) || 0;
                    rateLabel = `${yearRate}% –≥–æ–¥–æ–≤—ã—Ö`;
            }
            return { yearRate, rateLabel, keyRate };
        }

        function showCalcError(msg) {
            const errorEl = document.getElementById('calcError');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
        }

        function hideCalcError() {
            document.getElementById('calcError').style.display = 'none';
        }

        function calculatePenalty() {
            hideCalcError();
            const calcType = document.getElementById('calcType').value;
            const { yearRate, rateLabel, keyRate } = getRate();

            if (yearRate <= 0) {
                showCalcError('–£–∫–∞–∂–∏—Ç–µ —Å—Ç–∞–≤–∫—É –Ω–µ—É—Å—Ç–æ–π–∫–∏');
                return;
            }

            let results = [];
            let totalPenalty = 0;
            let totalPenalty333 = 0;

            if (calcType === 'simple') {
                const debt = parseFloat(document.getElementById('calcDebt').value) || 0;
                const startDate = document.getElementById('calcStartDate').value;
                const endDate = document.getElementById('calcEndDate').value;

                if (!debt) { showCalcError('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–æ–ª–≥–∞'); return; }
                if (!startDate) { showCalcError('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏'); return; }
                if (!endDate) { showCalcError('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è'); return; }

                const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
                if (days <= 0) { showCalcError('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'); return; }

                const penalty = debt * (yearRate / 100) * (days / 365);
                const penalty333 = debt * (keyRate * 2 / 100) * (days / 365);

                results.push({
                    amount: debt,
                    startDate,
                    endDate,
                    days,
                    penalty,
                    penalty333
                });

                totalPenalty = penalty;
                totalPenalty333 = penalty333;

            } else {
                const endDatePeriods = document.getElementById('calcEndDatePeriods').value;
                if (!endDatePeriods) { showCalcError('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞'); return; }
                if (calcPeriods.length === 0) { showCalcError('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–µ—Ä–∏–æ–¥'); return; }

                for (const id of calcPeriods) {
                    const amount = parseFloat(document.getElementById(`period-amount-${id}`).value) || 0;
                    const dueDate = document.getElementById(`period-due-${id}`).value;
                    const doneDate = document.getElementById(`period-done-${id}`).value;

                    if (!amount || !dueDate) continue;

                    const calcEndDate = doneDate || endDatePeriods;
                    const days = Math.ceil((new Date(calcEndDate) - new Date(dueDate)) / (1000 * 60 * 60 * 24));

                    if (days > 0) {
                        const penalty = amount * (yearRate / 100) * (days / 365);
                        const penalty333 = amount * (keyRate * 2 / 100) * (days / 365);

                        results.push({
                            amount,
                            startDate: dueDate,
                            endDate: calcEndDate,
                            days,
                            penalty,
                            penalty333,
                            isDone: !!doneDate
                        });

                        totalPenalty += penalty;
                        totalPenalty333 += penalty333;
                    }
                }

                if (results.length === 0) {
                    showCalcError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—è –±—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞');
                    return;
                }
            }

            // Render results
            const detailsHtml = results.map((r, i) => `
                <div style="background: #F4F7F9; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="color: #8899A6;">${results.length > 1 ? `#${i + 1}: ` : ''}${r.amount.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        <span style="color: #1E3A5F; font-weight: 600;">${r.penalty.toLocaleString('ru-RU', {maximumFractionDigits: 2})} ‚ÇΩ</span>
                    </div>
                    <div style="color: #8899A6; font-size: 11px;">
                        ${formatDate(r.startDate)} ‚Äî ${formatDate(r.endDate)} (${r.days} –¥–Ω.)
                        ${r.isDone ? '<span style="color: #48BB78;"> ‚úì –∏—Å–ø–æ–ª–Ω–µ–Ω–æ</span>' : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('calcResultDetails').innerHTML = `
                <div class="calc-result-item" style="border-bottom: none; padding-bottom: 0;">
                    <span class="label">–°—Ç–∞–≤–∫–∞</span>
                    <span class="value">${rateLabel}</span>
                </div>
                ${detailsHtml}
            `;

            document.getElementById('resultPenalty').textContent = totalPenalty.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('result333').textContent = totalPenalty333.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('calcResult').style.display = 'block';
        }

        function toggleCustomRate() {
            const rateType = document.getElementById('calcRateType').value;
            document.getElementById('customRateRow').style.display = rateType === 'contract' ? 'block' : 'none';
        }

        function clearCalculator() {
            document.getElementById('calcType').value = 'simple';
            document.getElementById('simpleCalc').style.display = 'block';
            document.getElementById('periodsCalc').style.display = 'none';
            document.getElementById('calcDebt').value = '';
            document.getElementById('calcStartDate').value = '';
            document.getElementById('calcEndDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('calcEndDatePeriods').value = new Date().toISOString().split('T')[0];
            document.getElementById('calcRateType').value = 'contract';
            document.getElementById('calcCustomRate').value = '';
            document.getElementById('customRateRow').style.display = 'block';
            document.getElementById('calcResult').style.display = 'none';
            document.getElementById('periodsList').innerHTML = '';
            calcPeriods = [];
            hideCalcError();
        }

        function updateStatsAfterGeneration(model, time) {
            stats.total++;
            stats.times.push(time);
            if (stats.times.length > 100) stats.times.shift();
            stats.models[model] = (stats.models[model] || 0) + 1;
            localStorage.setItem('generationStats', JSON.stringify(stats));
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalGenerations').textContent = stats.total;
            if (stats.times.length > 0) document.getElementById('avgTime').textContent = (stats.times.reduce((a, b) => a + b, 0) / stats.times.length).toFixed(1) + ' —Å–µ–∫.';
            if (Object.keys(stats.models).length > 0) document.getElementById('topModel').textContent = MODEL_NAMES[Object.entries(stats.models).sort((a, b) => b[1] - a[1])[0][0]] || '-';
        }

        function saveDraft() {
            const draft = { claimText: document.getElementById('claimText').value, responseText: document.getElementById('responseText').value, userComments: document.getElementById('userComments').value, selectedModel };
            if (draft.claimText || draft.responseText || draft.userComments) localStorage.setItem('draft', JSON.stringify(draft));
        }

        function loadDraft() {
            const draft = JSON.parse(localStorage.getItem('draft') || 'null');
            if (draft) {
                document.getElementById('claimText').value = draft.claimText || '';
                document.getElementById('responseText').value = draft.responseText || '';
                document.getElementById('userComments').value = draft.userComments || '';
                if (draft.selectedModel) { selectedModel = draft.selectedModel; document.querySelectorAll('.model-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.model === selectedModel)); }
            }
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button if not already installed
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-info btn-sm';
            installBtn.innerHTML = 'üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            installBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                }
            };
            document.body.appendChild(installBtn);

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installBtn.parentNode) {
                    installBtn.style.transition = 'opacity 0.5s';
                    installBtn.style.opacity = '0';
                    setTimeout(() => installBtn.remove(), 500);
                }
            }, 10000);
        });

        // Handle app installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
