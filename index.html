<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti333.AI - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤</title>
    <link rel="icon" type="image/x-icon" href="/favicon-32.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a2744">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Anti333.AI">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(145deg, #E8EEF2 0%, #D4DEE7 50%, #C5D3E0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #FAFBFC;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(30, 58, 95, 0.15);
            overflow: hidden;
        }
        .header {
            background: #1a2744;
            color: white;
            padding: 20px 30px;
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #C9A227, #E8C547, #C9A227);
        }
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .header-logo {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
        }
        .header-text {
            flex: 1;
        }
        .header-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 0;
        }
        .header-title .anti { color: white; }
        .header-title .num {
            background: linear-gradient(180deg, #E8C547 0%, #C9A227 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-title .ai { color: white; }
        .header-subtitle {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }
        .header-subtitle-gold {
            color: #E8C547;
            font-weight: 500;
        }
        .stats-bar {
            background: #F4F7F9;
            padding: 8px 20px;
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #8899A6;
            border-bottom: 1px solid #E1E8ED;
        }
        .stat-item { display: flex; align-items: center; gap: 6px; }
        .stat-value { font-weight: 600; color: #1E3A5F; }
        .tabs-container {
            display: flex;
            background: #F4F7F9;
            border-bottom: 1px solid #E1E8ED;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .tabs-container::-webkit-scrollbar { display: none; }
        .main-tab {
            padding: 12px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 500;
            color: #4A5568;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .main-tab:hover { color: #1E3A5F; }
        .main-tab.active { color: #1E3A5F; border-bottom-color: #C9A227; background: #FAFBFC; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 600px;
        }
        .form-section {
            padding: 25px;
            background: #F4F7F9;
            border-right: 1px solid #E1E8ED;
            overflow-y: auto;
            max-height: 80vh;
        }
        .output-section {
            padding: 25px;
            background: #FAFBFC;
            overflow-y: auto;
            max-height: 80vh;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #C9A227;
        }
        .document-block {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .document-block h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 12px;
        }
        .document-block h3 .required { color: #C9A227; }
        .document-block h3 .optional { font-weight: 400; font-size: 11px; color: #8899A6; }
        .document-block h3 .file-limit { font-weight: 400; font-size: 11px; color: #8899A6; margin-left: 8px; }
        .input-tabs { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .tab-btn {
            padding: 6px 12px;
            border: 1px solid #E1E8ED;
            background: #F4F7F9;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            color: #4A5568;
        }
        .tab-btn.active { background: #1a2744; color: white; border-color: #1a2744; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-upload {
            border: 2px dashed #CBD5E0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #FAFBFC;
        }
        .file-upload:hover { border-color: #C9A227; background: #FFFDF5; }
        .file-upload.has-file { border-color: #48BB78; background: #F0FFF4; }
        .file-upload input[type="file"] { display: none; }
        .file-upload .upload-icon { font-size: 24px; margin-bottom: 8px; }
        .file-upload .upload-text { font-size: 12px; color: #8899A6; }
        .file-list { margin-top: 10px; }
        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #F4F7F9;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .file-item .file-preview {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            background: #E1E8ED;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .file-item .file-preview.clickable {
            cursor: pointer;
        }
        .file-item .file-preview.clickable:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .file-item .file-preview img { width: 100%; height: 100%; object-fit: cover; }
        .file-item .file-preview .zoom-hint {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .file-item .file-preview:hover .zoom-hint { opacity: 1; }
        /* Image preview modal */
        .image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }
        .image-preview-modal.active { display: flex; }
        .image-preview-modal img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-preview-filename {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: #1E3A5F;
        }
        .file-item .file-info { flex: 1; min-width: 0; }
        .file-item .file-name { font-size: 12px; color: #2D3748; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item .file-size { font-size: 10px; color: #8899A6; }
        .file-item .remove-file {
            color: #E53E3E;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 4px;
            background: none;
            border: none;
            opacity: 0.7;
            transition: opacity 0.2s, background 0.2s;
            flex-shrink: 0;
        }
        .file-item .remove-file:hover { opacity: 1; background: #FED7D7; }
        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 11px;
            color: #8899A6;
        }
        .clear-all-files {
            color: #E53E3E;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .clear-all-files:hover { background: #FED7D7; }
        .upload-buttons { display: flex; gap: 8px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
        .upload-btn {
            padding: 8px 16px;
            border: 1px solid #E1E8ED;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #4A5568;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .upload-btn:hover { background: #F4F7F9; border-color: #C9A227; }
        textarea, select, input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #E1E8ED;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 120px; }
        textarea:focus, select:focus, input:focus { outline: none; border-color: #C9A227; }
        .model-selector {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .model-selector h3 { font-size: 14px; font-weight: 600; color: #1E3A5F; margin-bottom: 12px; }
        .model-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .model-option {
            padding: 10px;
            border: 2px solid #E1E8ED;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
        }
        .model-option:hover { border-color: #C9A227; }
        .model-option.selected { border-color: #1a2744; background: #F0F5FF; }
        .model-option .model-name { font-weight: 600; font-size: 13px; color: #1E3A5F; }
        .model-option .model-desc { font-size: 11px; color: #8899A6; margin-top: 4px; }
        .rates-info {
            background: #F0F5FF;
            border: 1px solid #C3D4E8;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .rates-info h4 { font-size: 13px; color: #1E3A5F; margin-bottom: 8px; }
        .button-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
        }
        .btn-primary { background: linear-gradient(135deg, #1a2744 0%, #243656 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #E8EEF2; color: #4A5568; }
        .btn-secondary:hover { background: #D4DEE7; }
        .btn-success { background: #48BB78; color: white; }
        .btn-warning { background: #ED8936; color: white; }
        .btn-info { background: #4299E1; color: white; }
        .btn-sm { padding: 8px 12px; font-size: 12px; }
        /* Progress Bar */
        .progress-container {
            display: none;
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .progress-container.active { display: block; }
        .progress-steps { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .progress-step::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #E1E8ED;
        }
        .progress-step:last-child::after { display: none; }
        .progress-step .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #E1E8ED;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 1;
        }
        .progress-step.active .step-icon { background: #C9A227; color: white; }
        .progress-step.completed .step-icon { background: #48BB78; color: white; }
        .progress-step .step-label { font-size: 11px; color: #8899A6; margin-top: 8px; text-align: center; }
        .progress-step.active .step-label { color: #1E3A5F; font-weight: 600; }
        .progress-bar-track { height: 6px; background: #E1E8ED; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #C9A227, #E8C547); width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; font-size: 13px; color: #4A5568; margin-top: 10px; }
        .progress-time { text-align: center; font-size: 11px; color: #8899A6; margin-top: 5px; }
        /* Animated progress bar */
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(201, 162, 39, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(201, 162, 39, 0); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .progress-step.active .step-icon {
            animation: pulse 1.5s ease-in-out infinite;
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #C9A227 0%, #E8C547 25%, #C9A227 50%, #E8C547 75%, #C9A227 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        .progress-step::after {
            transition: background 0.3s ease;
        }
        .progress-step.completed::after {
            background: #48BB78 !important;
        }
        .progress-substep {
            font-size: 10px;
            color: #C9A227;
            margin-top: 4px;
            min-height: 14px;
        }
        .progress-details {
            background: #F4F7F9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 12px;
            font-size: 11px;
            color: #4A5568;
        }
        .progress-details-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        .progress-details-item .label { color: #8899A6; }
        .progress-details-item .value { font-weight: 500; color: #1E3A5F; }
        .output-box {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 25px;
            min-height: 300px;
            font-size: 14px;
            line-height: 1.6;
            color: #2D3748;
        }
        .output-box .doc-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a2744;
            text-align: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
        }
        .output-box .doc-title-line {
            text-align: center;
            color: #C9A227;
            margin-bottom: 20px;
            font-size: 12px;
            letter-spacing: 2px;
        }
        .output-box .doc-subtitle {
            text-align: center;
            color: #4A5568;
            font-size: 13px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .output-box .section-heading {
            font-size: 15px;
            font-weight: 700;
            color: #1a2744;
            margin: 24px 0 12px;
            padding: 8px 12px;
            background: linear-gradient(90deg, #f0f4f8 0%, transparent 100%);
            border-left: 3px solid #C9A227;
            border-radius: 0 4px 4px 0;
        }
        .output-box .subsection-heading {
            font-size: 14px;
            font-weight: 600;
            color: #1a2744;
            margin: 16px 0 8px;
        }
        .output-box .paragraph {
            margin-bottom: 12px;
            text-align: justify;
        }
        .output-empty { color: #A0AEC0; font-style: italic; text-align: center; padding-top: 80px; }
        .output-editable:focus { outline: 2px solid #C9A227; }
        .model-badge {
            display: inline-block;
            background: #E8EEF2;
            color: #1E3A5F;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .time-badge {
            display: inline-block;
            background: #F0FFF4;
            color: #276749;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .action-buttons .btn { flex: 1; min-width: 100px; }
        .error-box {
            background: #FFF5F5;
            border: 1px solid #FC8181;
            border-radius: 8px;
            padding: 12px;
            color: #C53030;
            margin-bottom: 15px;
            display: none;
        }
        .error-box.active { display: block; }
        /* Comparison */
        .comparison-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E1E8ED;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }
        .comparison-select:focus { outline: none; border-color: #C9A227; }
        .comparison-container { display: none; grid-template-columns: 1fr 1fr; gap: 20px; }
        .comparison-container.active { display: grid; }
        .comparison-column { background: white; border: 1px solid #E1E8ED; border-radius: 8px; overflow: hidden; }
        .comparison-header { background: #F4F7F9; padding: 12px; border-bottom: 1px solid #E1E8ED; font-weight: 600; font-size: 13px; color: #1E3A5F; }
        .comparison-content { padding: 15px; max-height: 400px; overflow-y: auto; font-size: 13px; line-height: 1.6; white-space: pre-wrap; }
        /* Calculator */
        .calculator-section { padding: 25px; }
        .calculator-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
        @media (max-width: 900px) { .calculator-layout { grid-template-columns: 1fr; } }
        .calc-form { background: white; border: 1px solid #E1E8ED; border-radius: 8px; padding: 20px; }
        .calc-row { margin-bottom: 15px; }
        .calc-row label { display: block; font-size: 13px; font-weight: 500; color: #1E3A5F; margin-bottom: 6px; }
        .calc-result { background: #F0F5FF; border: 1px solid #C3D4E8; border-radius: 8px; padding: 20px; }
        .calc-result h4 { font-size: 14px; color: #1E3A5F; margin-bottom: 15px; }
        .calc-result-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #E1E8ED; }
        .calc-result-item:last-child { border-bottom: none; }
        .calc-result-item .label { color: #4A5568; }
        .calc-result-item .value { font-weight: 600; color: #1E3A5F; }
        .calc-result-item.total { font-size: 16px; }
        .calc-result-item.total .value { color: #C9A227; }
        /* Period rows */
        .payment-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            padding: 10px;
            background: #F4F7F9;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .payment-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #E1E8ED;
            border-radius: 4px;
            font-size: 12px;
        }
        .payment-row label {
            font-size: 11px;
            color: #8899A6;
            margin-bottom: 4px;
            display: block;
        }
        .remove-payment {
            background: none;
            border: none;
            color: #E53E3E;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 4px;
        }
        .remove-payment:hover { background: #FED7D7; }
        @media (max-width: 600px) {
            .payment-row {
                grid-template-columns: 1fr 1fr;
            }
        }
        /* Templates */
        .templates-section { padding: 25px; }
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .template-card { background: white; border: 1px solid #E1E8ED; border-radius: 8px; padding: 15px; cursor: pointer; }
        .template-card:hover { border-color: #C9A227; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .template-card h4 { font-size: 14px; color: #1E3A5F; margin-bottom: 8px; }
        .template-card p { font-size: 12px; color: #8899A6; line-height: 1.5; }
        .template-card .template-tags { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .template-tag { background: #F0F5FF; color: #1E3A5F; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        /* History */
        .history-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #E1E8ED; }
        .history-section h4 { font-size: 13px; color: #1E3A5F; margin-bottom: 10px; }
        .history-item {
            background: #F4F7F9;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            position: relative;
        }
        .history-item:hover { background: #E8EEF2; }
        .history-item .history-content { flex: 1; }
        .history-item .date { color: #8899A6; font-size: 11px; }
        .history-item .preview { color: #4A5568; margin-top: 4px; }
        .history-item .delete-history {
            color: #E53E3E;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
            flex-shrink: 0;
        }
        .history-item:hover .delete-history { opacity: 1; }
        .history-item .delete-history:hover { background: #FED7D7; }
        .history-section .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .history-section .history-header h4 { margin: 0; }
        .history-section .clear-all-history {
            font-size: 11px;
            color: #E53E3E;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .history-section .clear-all-history:hover { background: #FED7D7; }
        .footer { background: #F4F7F9; padding: 12px; text-align: center; border-top: 1px solid #E1E8ED; display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; }
        .footer .author { font-size: 11px; color: #8899A6; }
        .clear-cache-btn { background: none; border: 1px solid #E1E8ED; padding: 4px 10px; border-radius: 6px; font-size: 11px; color: #8899A6; cursor: pointer; transition: all 0.2s; }
        .clear-cache-btn:hover { background: #FED7D7; border-color: #FC8181; color: #C53030; }
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #E1E8ED; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; color: #1E3A5F; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #8899A6; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid #E1E8ED; display: flex; gap: 10px; justify-content: flex-end; }
        @media (max-width: 968px) {
            .main-content { grid-template-columns: 1fr; }
            .form-section, .output-section { max-height: none; border-right: none; }
            .form-section { border-bottom: 1px solid #E1E8ED; }
            .model-options { grid-template-columns: 1fr; }
            .comparison-container { grid-template-columns: 1fr; }
            .stats-bar { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="/icon-192.png" alt="Anti333.AI Logo" class="header-logo">
                <div class="header-text">
                    <div class="header-title">
                        <span class="anti">Anti</span><span class="num">333</span><span class="ai">.AI</span>
                    </div>
                    <div class="header-subtitle">
                        <span class="header-subtitle-gold">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤</span><br>
                        –ø—Ä–æ—Ç–∏–≤ —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–µ—É—Å—Ç–æ–π–∫–∏ –ø–æ —Å—Ç. 333 –ì–ö –†–§
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏–π: <span class="stat-value" id="totalGenerations">0</span></div>
            <div class="stat-item">‚è±Ô∏è –°—Ä. –≤—Ä–µ–º—è: <span class="stat-value" id="avgTime">-</span></div>
            <div class="stat-item">üèÜ –ü–æ–ø—É–ª—è—Ä–Ω–∞—è –º–æ–¥–µ–ª—å: <span class="stat-value" id="topModel">-</span></div>
        </div>

        <div class="tabs-container">
            <button class="main-tab active" onclick="switchMainTab('generator')">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
            <button class="main-tab" onclick="switchMainTab('calculator')">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
            <button class="main-tab" onclick="switchMainTab('templates')">–®–∞–±–ª–æ–Ω—ã</button>
            <button class="main-tab" onclick="switchMainTab('comparison')">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
            <button class="main-tab" onclick="switchMainTab('knowledge')">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</button>
        </div>

        <!-- Generator Tab -->
        <div id="generator-panel" class="tab-panel active">
            <div class="main-content">
                <div class="form-section">
                    <h2 class="section-title">–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>

                    <div class="document-block">
                        <h3>–ò—Å–∫ –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –Ω–µ—É—Å—Ç–æ–π–∫–∏ <span class="required">*</span> <span class="file-limit">(–¥–æ 3 —Ñ–∞–π–ª–æ–≤)</span></h3>
                        <div class="input-tabs">
                            <button class="tab-btn active" onclick="switchTab('claim', 'file', this)">–§–∞–π–ª—ã</button>
                            <button class="tab-btn" onclick="switchTab('claim', 'text', this)">–¢–µ–∫—Å—Ç</button>
                        </div>
                        <div id="claim-file-tab" class="tab-content active">
                            <div class="file-upload" id="claim-upload-area" onclick="document.getElementById('claimFiles').click()">
                                <input type="file" id="claimFiles" multiple accept=".txt,.rtf,.docx,.doc,.pdf,.jpg,.jpeg,.png,.heic" onchange="handleMultiFileSelect(this, 'claim')" onclick="event.stopPropagation()">
                                <div class="upload-icon">üìÑ</div>
                                <div class="upload-text">DOCX, PDF, TXT, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å. 10 –ú–ë)</div>
                            </div>
                            <div id="claim-file-list" class="file-list"></div>
                        </div>
                        <div id="claim-text-tab" class="tab-content">
                            <textarea id="claimText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏—Å–∫–∞..."></textarea>
                        </div>
                    </div>

                    <div class="document-block">
                        <h3>–û—Ç–∑—ã–≤ –æ—Ç–≤–µ—Ç—á–∏–∫–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span> <span class="file-limit">(–¥–æ 3 —Ñ–∞–π–ª–æ–≤)</span></h3>
                        <div class="input-tabs">
                            <button class="tab-btn active" onclick="switchTab('response', 'file', this)">–§–∞–π–ª—ã</button>
                            <button class="tab-btn" onclick="switchTab('response', 'text', this)">–¢–µ–∫—Å—Ç</button>
                        </div>
                        <div id="response-file-tab" class="tab-content active">
                            <div class="file-upload" id="response-upload-area" onclick="document.getElementById('responseFiles').click()">
                                <input type="file" id="responseFiles" multiple accept=".txt,.rtf,.docx,.doc,.pdf,.jpg,.jpeg,.png,.heic" onchange="handleMultiFileSelect(this, 'response')" onclick="event.stopPropagation()">
                                <div class="upload-icon">üìã</div>
                                <div class="upload-text">–•–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ —Å–Ω–∏–∂–µ–Ω–∏–∏</div>
                            </div>
                            <div id="response-file-list" class="file-list"></div>
                        </div>
                        <div id="response-text-tab" class="tab-content">
                            <textarea id="responseText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞..."></textarea>
                        </div>
                    </div>

                    <div class="document-block">
                        <h3>–ü–æ—è—Å–Ω–µ–Ω–∏—è <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></h3>
                        <textarea id="userComments" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∞–∫—Ü–µ–Ω—Ç—ã, –ø–æ–∂–µ–ª–∞–Ω–∏—è..." style="min-height: 80px;"></textarea>
                    </div>

                    <div class="model-selector">
                        <h3>–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏</h3>
                        <div class="model-options">
                            <div class="model-option selected" data-model="gemini-3-pro-preview" onclick="selectModel(this)">
                                <div class="model-name">Gemini 3 Pro</div>
                                <div class="model-desc">Google, –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑</div>
                            </div>
                            <div class="model-option" data-model="claude-opus-4-5-20251101" onclick="selectModel(this)">
                                <div class="model-name">Claude Opus 4.5</div>
                                <div class="model-desc">Anthropic, –º–æ—â–Ω—ã–π</div>
                            </div>
                            <div class="model-option" data-model="gpt-5.2" onclick="selectModel(this)">
                                <div class="model-name">ChatGPT 5.2</div>
                                <div class="model-desc">OpenAI, –Ω–æ–≤–µ–π—à–∏–π</div>
                            </div>
                        </div>
                    </div>

                    <div class="rates-info">
                        <h4>üìä –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§</h4>
                        <div id="ratesContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>

                    <div class="button-group">
                        <button id="analyzeBtn" class="btn btn-primary" onclick="generateArguments()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-secondary" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>

                    <div class="history-section" id="historySection" style="display: none;">
                        <div class="history-header">
                            <h4>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h4>
                            <button class="clear-all-history" onclick="clearAllHistory()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                        </div>
                        <div id="historyList"></div>
                    </div>
                </div>

                <div class="output-section">
                    <h2 class="section-title">–ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–æ—Ç–∏–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç. 333 –ì–ö –†–§</h2>

                    <div id="progressContainer" class="progress-container">
                        <div class="progress-steps">
                            <div class="progress-step" data-step="1">
                                <div class="step-icon">üìÇ</div>
                                <div class="step-label">–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</div>
                                <div class="progress-substep" id="substep-1"></div>
                            </div>
                            <div class="progress-step" data-step="2">
                                <div class="step-icon">üîç</div>
                                <div class="step-label">OCR</div>
                                <div class="progress-substep" id="substep-2"></div>
                            </div>
                            <div class="progress-step" data-step="3">
                                <div class="step-icon">ü§ñ</div>
                                <div class="step-label">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
                                <div class="progress-substep" id="substep-3"></div>
                            </div>
                            <div class="progress-step" data-step="4">
                                <div class="step-icon">‚úÖ</div>
                                <div class="step-label">–ì–æ—Ç–æ–≤–æ</div>
                                <div class="progress-substep" id="substep-4"></div>
                            </div>
                        </div>
                        <div class="progress-bar-track"><div class="progress-bar-fill" id="progressFill"></div></div>
                        <div class="progress-text" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                        <div class="progress-time" id="progressTime"></div>
                        <div class="progress-details" id="progressDetails" style="display: none;">
                            <div class="progress-details-item">
                                <span class="label">–§–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</span>
                                <span class="value" id="filesProcessed">0 / 0</span>
                            </div>
                            <div class="progress-details-item">
                                <span class="label">–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:</span>
                                <span class="value" id="currentStage">-</span>
                            </div>
                        </div>
                    </div>

                    <div id="errorBox" class="error-box"></div>
                    <div id="outputBadges" style="display: none;"><span id="modelBadge" class="model-badge"></span><span id="timeBadge" class="time-badge"></span></div>
                    <div id="output" class="output-box output-empty" contenteditable="false">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª</div>

                    <div id="actionButtons" class="action-buttons" style="display: none;">
                        <button class="btn btn-secondary btn-sm" onclick="toggleEdit()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-primary btn-sm" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-success btn-sm" onclick="downloadDocx()">üì• DOCX</button>
                        <button class="btn btn-warning btn-sm" onclick="regenerateWithDifferentModel()">üîÑ –î—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å</button>
                        <button class="btn btn-secondary btn-sm" onclick="saveAsTemplate()">üíæ –®–∞–±–ª–æ–Ω</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator-panel" class="tab-panel">
            <div class="calculator-section">
                <h2 class="section-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–µ—É—Å—Ç–æ–π–∫–∏</h2>

                <div class="calculator-layout">
                    <div class="calc-form">
                        <div class="calc-row">
                            <label>–°—É–º–º–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–ª–≥–∞ (—Ä—É–±.)</label>
                            <input type="number" id="calcDebt" placeholder="1000000">
                        </div>
                        <div class="calc-row">
                            <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏</label>
                            <input type="date" id="calcStartDate">
                        </div>
                        <div class="calc-row">
                            <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞—Å—á—ë—Ç–∞</label>
                            <input type="date" id="calcEndDate">
                        </div>

                        <div style="margin: 20px 0 10px; padding-top: 15px; border-top: 1px solid #E1E8ED;">
                            <label style="font-size: 13px; font-weight: 600; color: #1E3A5F;">–ß–∞—Å—Ç–∏—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–µ—Å–ª–∏ –±—ã–ª–∏)</label>
                            <p style="font-size: 11px; color: #8899A6; margin: 4px 0 10px;">–î–æ–±–∞–≤—å—Ç–µ –¥–∞—Ç—ã –∏ —Å—É–º–º—ã —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞</p>
                        </div>
                        <div id="paymentsList"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addPayment()" style="margin-top: 8px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>

                        <div class="calc-row" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #E1E8ED;">
                            <label>–°—Ç–∞–≤–∫–∞ –Ω–µ—É—Å—Ç–æ–π–∫–∏</label>
                            <select id="calcRateType" onchange="toggleCustomRate()">
                                <option value="contract">–ü–æ –¥–æ–≥–æ–≤–æ—Ä—É (–≤–≤–µ—Å—Ç–∏)</option>
                                <option value="395">–°—Ç. 395 –ì–ö (–∫–ª—é—á. —Å—Ç–∞–≤–∫–∞)</option>
                                <option value="double">2x –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏</option>
                                <option value="01">0.1% –≤ –¥–µ–Ω—å</option>
                                <option value="05">0.5% –≤ –¥–µ–Ω—å</option>
                                <option value="1">1% –≤ –¥–µ–Ω—å</option>
                            </select>
                        </div>
                        <div class="calc-row" id="customRateRow">
                            <label>–°—Ç–∞–≤–∫–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É (% –≥–æ–¥–æ–≤—ã—Ö)</label>
                            <input type="number" id="calcCustomRate" placeholder="36">
                        </div>

                        <div id="calcError" style="display: none; background: #FFF5F5; border: 1px solid #FC8181; border-radius: 6px; padding: 10px; margin-top: 15px; color: #C53030; font-size: 13px;"></div>

                        <div class="button-group" style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="calculatePenalty()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                            <button class="btn btn-secondary" onclick="clearCalculator()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>

                    <div class="calc-result" id="calcResult" style="display: none;">
                        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞</h4>
                        <div id="calcResultDetails"></div>
                        <div class="calc-result-item total" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #C9A227;">
                            <span class="label">–ò—Ç–æ–≥–æ –Ω–µ—É—Å—Ç–æ–π–∫–∞</span>
                            <span class="value" id="resultPenalty">-</span>
                        </div>
                        <div class="calc-result-item">
                            <span class="label">–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ —Å—Ç. 333 (–¥–æ 2x –∫–ª—é—á.)</span>
                            <span class="value" id="result333">-</span>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #E1E8ED;">
                            <button class="btn btn-success btn-sm" onclick="downloadCalcDocx()">üì• –°–∫–∞—á–∞—Ç—å DOCX</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Tab -->
        <div id="templates-panel" class="tab-panel">
            <div class="templates-section">
                <h2 class="section-title">–®–∞–±–ª–æ–Ω—ã –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤</h2>
                <p style="color: #8899A6; margin-bottom: 20px; font-size: 13px;">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ç–∏–ø–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π.</p>
                <div id="templateGrid" class="template-grid"></div>
                <div id="noTemplates" style="text-align: center; padding: 40px; color: #8899A6;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —É–¥–∞—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</div>
            </div>
        </div>

        <!-- Comparison Tab -->
        <div id="comparison-panel" class="tab-panel">
            <div style="padding: 25px;">
                <h2 class="section-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
                <p style="color: #8899A6; margin-bottom: 20px; font-size: 13px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.</p>

                <div class="comparison-selectors" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="font-size: 13px; font-weight: 500; color: #1E3A5F; display: block; margin-bottom: 8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç 1</label>
                        <select id="compare1" class="comparison-select" onchange="updateComparisonPreview(1)">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 500; color: #1E3A5F; display: block; margin-bottom: 8px;">–†–µ–∑—É–ª—å—Ç–∞—Ç 2</label>
                        <select id="compare2" class="comparison-select" onchange="updateComparisonPreview(2)">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="runHistoryComparison()" id="compareBtn">–°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>

                <div id="noHistoryMessage" style="text-align: center; padding: 40px; color: #8899A6; display: none;">
                    –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä".
                </div>

                <div id="comparisonContainer" class="comparison-container" style="margin-top: 20px;">
                    <div class="comparison-column">
                        <div class="comparison-header" id="header-1">–†–µ–∑—É–ª—å—Ç–∞—Ç 1</div>
                        <div class="comparison-content" id="content-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</div>
                    </div>
                    <div class="comparison-column">
                        <div class="comparison-header" id="header-2">–†–µ–∑—É–ª—å—Ç–∞—Ç 2</div>
                        <div class="comparison-content" id="content-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Base Tab -->
        <div id="knowledge-panel" class="tab-panel">
            <div style="padding: 25px;">
                <h2 class="section-title">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>
                <p style="color: #8899A6; margin-bottom: 20px; font-size: 13px;">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—É–¥–µ–±–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–Ω—É–º–æ–≤, –æ–±–∑–æ—Ä—ã –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –Ω–∞—É—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏.</p>

                <div class="calculator-layout">
                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="calc-form">
                        <h4 style="margin-bottom: 15px; color: #1E3A5F;">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</h4>

                        <!-- –¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
                        <div class="calc-row">
                            <label>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                            <select id="kbDocType" onchange="updateKbFormLabels()" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px;">
                                <option value="court_decision">üìã –°—É–¥–µ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ</option>
                                <option value="plenum_resolution">‚öñÔ∏è –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–ª–µ–Ω—É–º–∞ –í–° –†–§</option>
                                <option value="practice_review">üìä –û–±–∑–æ—Ä —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏</option>
                                <option value="scientific_article">üìö –ù–∞—É—á–Ω–∞—è —Å—Ç–∞—Ç—å—è</option>
                                <option value="ai_review">ü§ñ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä –æ—Ç –ò–ò</option>
                            </select>
                        </div>

                        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
                        <div class="calc-row" style="background: #F8FAFC; border: 2px dashed #CBD5E0; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #1E3A5F;">üìÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (PDF/DOCX)</label>
                            <input type="file" id="kbDocumentFile" accept=".pdf,.docx,.doc" style="margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-secondary" onclick="parseKbDocument()" id="kbParseBtn">üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å</button>
                                <span id="kbParseStatus" style="font-size: 12px; color: #8899A6;"></span>
                            </div>
                            <p style="font-size: 11px; color: #8899A6; margin-top: 8px; margin-bottom: 0;">AI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á—ë—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</p>
                        </div>

                        <div class="calc-row">
                            <label id="kbCaseNumberLabel">–ù–æ–º–µ—Ä –¥–µ–ª–∞ / –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                            <input type="text" id="kbCaseNumber" placeholder="–ê40-12345/2024 –∏–ª–∏ ‚Ññ 7">
                        </div>
                        <div class="calc-row">
                            <label id="kbCourtNameLabel">–°—É–¥ / –ò—Å—Ç–æ—á–Ω–∏–∫</label>
                            <input type="text" id="kbCourtName" placeholder="–ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å—É–¥ –≥. –ú–æ—Å–∫–≤—ã">
                        </div>
                        <div class="calc-row">
                            <label id="kbDecisionDateLabel">–î–∞—Ç–∞</label>
                            <input type="date" id="kbDecisionDate">
                        </div>
                        <div class="calc-row">
                            <label>–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
                            <textarea id="kbSummary" rows="3" placeholder="–û —á—ë–º –¥–æ–∫—É–º–µ–Ω—Ç, –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è..."></textarea>
                        </div>
                        <div class="calc-row">
                            <label id="kbFullTextLabel">–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
                            <textarea id="kbFullText" rows="5" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –≤—ã–¥–µ—Ä–∂–∫–∏..."></textarea>
                        </div>
                        <div class="calc-row">
                            <label id="kbKeyPointsLabel">–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã / –ø–æ–∑–∏—Ü–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                            <textarea id="kbKeyPoints" rows="3" placeholder="–ø—Ä–∞–≤–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è 1, –ø—Ä–∞–≤–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è 2..."></textarea>
                        </div>
                        <div class="calc-row" id="kbPenaltyRow" style="display: flex; gap: 20px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 8px; margin: 0;">
                                <input type="checkbox" id="kbPenaltyReduced"> –ù–µ—É—Å—Ç–æ–π–∫–∞ —Å–Ω–∏–∂–µ–Ω–∞
                            </label>
                            <div style="flex: 1;">
                                <input type="number" id="kbReductionPercent" placeholder="–ù–∞ —Å–∫–æ–ª—å–∫–æ % —Å–Ω–∏–∂–µ–Ω–∞" style="width: 100%;">
                            </div>
                        </div>
                        <div id="kbError" style="display: none; background: #FFF5F5; border: 1px solid #FC8181; border-radius: 6px; padding: 10px; margin-top: 15px; color: #C53030; font-size: 13px;"></div>
                        <div id="kbSuccess" style="display: none; background: #F0FFF4; border: 1px solid #68D391; border-radius: 6px; padding: 10px; margin-top: 15px; color: #276749; font-size: 13px;"></div>
                        <div class="button-group" style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="addCourtDecision()">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É</button>
                            <button class="btn btn-secondary" onclick="clearKbForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>

                    <!-- –°–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–∏–π -->
                    <div>
                        <h4 style="margin-bottom: 15px; color: #1E3A5F;">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (<span id="kbCount">0</span>)</h4>
                        <div id="kbList" style="max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; padding: 40px; color: #8899A6;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="loadKnowledgeBase()" style="margin-top: 10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="author">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ö–∏—Ä–∏–ª–ª –¢—Ä—É–±–∏—Ü—ã–Ω</div>
            <button class="clear-cache-btn" onclick="clearAllCache()" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</h3><button class="modal-close" onclick="closeTemplateModal()">√ó</button></div>
            <div class="modal-body">
                <div class="calc-row"><label>–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</label><input type="text" id="templateName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ—Å—Ä–æ—á–∫–∞ –ø–æ—Å—Ç–∞–≤–∫–∏"></div>
                <div class="calc-row"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="templateDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." style="min-height: 60px;"></textarea></div>
                <div class="calc-row"><label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input type="text" id="templateTags" placeholder="–ø–æ—Å—Ç–∞–≤–∫–∞, —Ç–æ–≤–∞—Ä, 333"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeTemplateModal()">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="confirmSaveTemplate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
        </div>
    </div>

    <!-- Model Selection Modal -->
    <div id="modelSelectModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3>–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3><button class="modal-close" onclick="closeModelSelectModal()">√ó</button></div>
            <div class="modal-body">
                <div class="model-options" style="flex-direction: column;">
                    <div class="model-option" data-model="gemini-3-pro-preview" onclick="selectAndRegenerate('gemini-3-pro-preview')">
                        <div class="model-name">Gemini 3 Pro</div>
                        <div class="model-desc">Google, –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑</div>
                    </div>
                    <div class="model-option" data-model="claude-opus-4-5-20251101" onclick="selectAndRegenerate('claude-opus-4-5-20251101')">
                        <div class="model-name">Claude Opus 4.5</div>
                        <div class="model-desc">Anthropic, –º–æ—â–Ω—ã–π</div>
                    </div>
                    <div class="model-option" data-model="gpt-5.2" onclick="selectAndRegenerate('gpt-5.2')">
                        <div class="model-name">ChatGPT 5.2</div>
                        <div class="model-desc">OpenAI, –Ω–æ–≤–µ–π—à–∏–π</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="closeImagePreview()">
        <button class="image-preview-close" onclick="closeImagePreview()">√ó</button>
        <img id="imagePreviewImg" src="" alt="Preview">
        <div class="image-preview-filename" id="imagePreviewFilename"></div>
    </div>

    <!-- Document Preview/Edit Modal -->
    <div id="docPreviewModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="docPreviewTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
                <button class="modal-close" onclick="closeDocPreview()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <input type="hidden" id="docPreviewId">

                <div class="calc-row">
                    <label>–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    <select id="docPreviewCategory" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="court_decision">üìã –°—É–¥–µ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ</option>
                        <option value="plenum_resolution">‚öñÔ∏è –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–ª–µ–Ω—É–º–∞ –í–° –†–§</option>
                        <option value="practice_review">üìä –û–±–∑–æ—Ä —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏</option>
                        <option value="scientific_article">üìö –ù–∞—É—á–Ω–∞—è —Å—Ç–∞—Ç—å—è</option>
                        <option value="ai_review">ü§ñ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä –æ—Ç –ò–ò</option>
                    </select>
                </div>

                <div class="calc-row">
                    <label>–ù–æ–º–µ—Ä / –ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="docPreviewCaseNumber" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;">
                </div>

                <div class="calc-row">
                    <label>–°—É–¥ / –ò—Å—Ç–æ—á–Ω–∏–∫</label>
                    <input type="text" id="docPreviewCourtName" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;">
                </div>

                <div class="calc-row">
                    <label>–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                    <textarea id="docPreviewSummary" rows="3" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;"></textarea>
                </div>

                <div class="calc-row" id="docPreviewPenaltyRow">
                    <label>–ú–∞—Ä–∫–µ—Ä –Ω–µ—É—Å—Ç–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–¥–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π)</label>
                    <select id="docPreviewPenalty" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;">
                        <option value="null">‚Äî –ù–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ ‚Äî</option>
                        <option value="false">‚úÖ –ù–µ —Å–Ω–∏–∂–µ–Ω–∞</option>
                        <option value="true">‚ö†Ô∏è –°–Ω–∏–∂–µ–Ω–∞</option>
                    </select>
                    <input type="number" id="docPreviewReductionPercent" placeholder="–ù–∞ —Å–∫–æ–ª—å–∫–æ % —Å–Ω–∏–∂–µ–Ω–∞" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px; margin-top: 8px;">
                </div>

                <div class="calc-row">
                    <label>–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <textarea id="docPreviewKeyPoints" rows="3" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px;"></textarea>
                </div>

                <div class="calc-row">
                    <label>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç <button onclick="toggleFullText()" style="background: none; border: none; color: #3182CE; cursor: pointer; font-size: 12px;">[–ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å]</button></label>
                    <div id="docPreviewFullTextContainer" style="display: none;">
                        <textarea id="docPreviewFullText" rows="10" style="width: 100%; padding: 8px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 12px; font-family: monospace;" readonly></textarea>
                    </div>
                </div>

                <div id="docPreviewError" style="display: none; background: #FFF5F5; border: 1px solid #FC8181; border-radius: 6px; padding: 10px; margin-top: 15px; color: #C53030; font-size: 13px;"></div>
                <div id="docPreviewSuccess" style="display: none; background: #F0FFF4; border: 1px solid #68D391; border-radius: 6px; padding: 10px; margin-top: 15px; color: #276749; font-size: 13px;"></div>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #E2E8F0; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeDocPreview()">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="btn btn-primary" onclick="saveDocChanges()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const MAX_FILES = 3, MAX_FILE_SIZE = 10 * 1024 * 1024;
        const MODEL_NAMES = {'gemini-3-pro-preview': 'Gemini 3 Pro', 'claude-opus-4-5-20251101': 'Claude Opus 4.5', 'gpt-5.2': 'ChatGPT 5.2'};
        const MODEL_SHORT = {'gemini-3-pro-preview': 'Gemini3', 'claude-opus-4-5-20251101': 'Opus45', 'gpt-5.2': 'GPT52'};

        function extractDisputeInfo(text) {
            if (!text) return { org: '', disputeType: '' };

            // –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            let org = '';
            const orgMatch = text.match(/(?:–û–û–û|–ê–û|–ó–ê–û|–ü–ê–û|–ò–ü|–û–ê–û)\s*[¬´"‚Äû]?([–ê-–Ø–∞-—è–Å—ëA-Za-z0-9\s\-]+)[¬ª""']?/);
            if (orgMatch) {
                org = orgMatch[1].trim().split(/\s+/).slice(0, 2).join('-').substring(0, 15);
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–ø–æ—Ä–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
            const disputeKeywords = [
                { pattern: /–Ω–µ—É—Å—Ç–æ–π–∫|–ø–µ–Ω[–∏—è]|—à—Ç—Ä–∞—Ñ/i, label: '–Ω–µ—É—Å—Ç–æ–π–∫–∞' },
                { pattern: /–ø–æ—Å—Ç–∞–≤–∫|—Ç–æ–≤–∞—Ä|–ø—Ä–æ–¥—É–∫—Ü/i, label: '–ø–æ—Å—Ç–∞–≤–∫–∞' },
                { pattern: /–ø–æ–¥—Ä—è–¥|—Ä–∞–±–æ—Ç[–∞—ã]|–°–ú–†|—Å—Ç—Ä–æ–∏—Ç–µ–ª/i, label: '–ø–æ–¥—Ä—è–¥' },
                { pattern: /–∞—Ä–µ–Ω–¥|–Ω–∞–π–º/i, label: '–∞—Ä–µ–Ω–¥–∞' },
                { pattern: /–∑–∞–π–º|–∫—Ä–µ–¥–∏—Ç|–ø—Ä–æ—Ü–µ–Ω—Ç/i, label: '–∑–∞–π–º' },
                { pattern: /—É—Å–ª—É–≥/i, label: '—É—Å–ª—É–≥–∏' },
                { pattern: /—Å—Ç—Ä–∞—Ö–æ–≤/i, label: '—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ' },
                { pattern: /–ø–µ—Ä–µ–≤–æ–∑|—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç|–≥—Ä—É–∑/i, label: '–ø–µ—Ä–µ–≤–æ–∑–∫–∞' },
                { pattern: /—É–±—ã—Ç–∫|—É—â–µ—Ä–±|–≤–æ–∑–º–µ—â–µ–Ω/i, label: '—É–±—ã—Ç–∫–∏' },
                { pattern: /–¥–æ–ª–≥|–∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç|–≤–∑—ã—Å–∫–∞–Ω/i, label: '–¥–æ–ª–≥' },
                { pattern: /–æ–ø–ª–∞—Ç|–ø–ª–∞—Ç–µ–∂/i, label: '–æ–ø–ª–∞—Ç–∞' }
            ];

            let disputeType = '';
            for (const kw of disputeKeywords) {
                if (kw.pattern.test(text)) {
                    disputeType = kw.label;
                    break;
                }
            }

            return { org, disputeType };
        }

        function generateFileName(ext) {
            const modelShort = MODEL_SHORT[lastUsedModel] || 'AI';

            // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ç–µ–∫—Å—Ç–∞
            let textToAnalyze = document.getElementById('claimText').value;
            if (!textToAnalyze && lastInputData && lastInputData.claim_text) {
                textToAnalyze = lastInputData.claim_text;
            }
            if (!textToAnalyze && lastResult) {
                textToAnalyze = lastResult;
            }

            const { org, disputeType } = extractDisputeInfo(textToAnalyze);

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è: –ú–æ–¥–µ–ª—å_–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è_–¢–∏–ø–°–ø–æ—Ä–∞.ext
            let parts = [modelShort];
            if (org) parts.push(org.replace(/[<>:"/\\|?*]/g, '_'));
            if (disputeType) parts.push(disputeType);
            if (parts.length === 1) parts.push('333');

            return parts.join('_') + '.' + ext;
        }

        let cachedRates = [], currentRate = null, lastResult = '', selectedModel = 'gemini-3-pro-preview', lastUsedModel = '', lastInputData = null;
        let claimFiles = [], responseFiles = [], isEditing = false, generationStartTime = null;

        // –ö—ç—à Object URLs –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
        const objectUrlCache = new Map();

        function getOrCreateObjectUrl(file) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è + —Ä–∞–∑–º–µ—Ä + lastModified –∫–∞–∫ –∫–ª—é—á
            const key = `${file.name}_${file.size}_${file.lastModified}`;
            if (!objectUrlCache.has(key)) {
                objectUrlCache.set(key, URL.createObjectURL(file));
            }
            return objectUrlCache.get(key);
        }

        function revokeFileObjectUrl(file) {
            const key = `${file.name}_${file.size}_${file.lastModified}`;
            if (objectUrlCache.has(key)) {
                URL.revokeObjectURL(objectUrlCache.get(key));
                objectUrlCache.delete(key);
            }
        }

        function revokeAllObjectUrls(files) {
            files.forEach(file => revokeFileObjectUrl(file));
        }
        let stats = JSON.parse(localStorage.getItem('generationStats') || '{"total":0,"times":[],"models":{}}');

        // === Fetch —Å —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è ===
        async function fetchWithTimeout(url, options = {}, timeoutMs = 60000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`‚è±Ô∏è –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª ${timeoutMs/1000} —Å–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å.`);
                }
                throw error;
            }
        }

        // === –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ API ===
        const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞
        const CACHE_VERSION = 'v3';  // –£–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const CACHE_PREFIX = `gen_cache_${CACHE_VERSION}_`;

        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –∫—ç—à–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        (function cleanOldVersionCache() {
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith('gen_cache_') && !k.startsWith(CACHE_PREFIX)) {
                    localStorage.removeItem(k);
                }
            });
        })();

        async function hashText(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
        }

        async function getCachedResult(claimText, responseText, model) {
            const key = CACHE_PREFIX + await hashText(claimText + '|' + responseText + '|' + model);
            const cached = localStorage.getItem(key);
            if (!cached) return null;
            try {
                const { result, timestamp, modelUsed } = JSON.parse(cached);
                if (Date.now() - timestamp > CACHE_TTL) {
                    localStorage.removeItem(key);
                    return null;
                }
                return { result, modelUsed };
            } catch { return null; }
        }

        async function setCachedResult(claimText, responseText, model, result, modelUsed) {
            const key = CACHE_PREFIX + await hashText(claimText + '|' + responseText + '|' + model);
            try {
                localStorage.setItem(key, JSON.stringify({ result, modelUsed, timestamp: Date.now() }));
                cleanOldCache();
            } catch (e) { console.warn('Cache write failed:', e); }
        }

        function cleanOldCache() {
            const keys = Object.keys(localStorage).filter(k => k.startsWith(CACHE_PREFIX));
            if (keys.length > 20) { // –•—Ä–∞–Ω–∏–º –º–∞–∫—Å–∏–º—É–º 20 –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const items = keys.map(k => {
                    try { return { key: k, ts: JSON.parse(localStorage.getItem(k)).timestamp }; }
                    catch { return { key: k, ts: 0 }; }
                }).sort((a, b) => a.ts - b.ts);
                items.slice(0, keys.length - 20).forEach(i => localStorage.removeItem(i.key));
            }
        }

        function clearAllCache() {
            const keys = Object.keys(localStorage).filter(k => k.startsWith('gen_cache_'));
            const count = keys.length;
            keys.forEach(k => localStorage.removeItem(k));
            if (count > 0) {
                alert(`–ö—ç—à –æ—á–∏—â–µ–Ω! –£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${count}`);
            } else {
                alert('–ö—ç—à —É–∂–µ –ø—É—Å—Ç');
            }
        }

        // === –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (Knowledge Base) ===
        async function loadKnowledgeBase() {
            const list = document.getElementById('kbList');
            const count = document.getElementById('kbCount');
            try {
                const response = await fetch('/api/knowledge');
                const data = await response.json();
                if (data.error) {
                    list.innerHTML = `<div style="text-align: center; padding: 20px; color: #E53E3E;">${data.error}</div>`;
                    return;
                }
                const decisions = data.decisions || [];
                count.textContent = decisions.length;
                if (decisions.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: #8899A6;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ!</div>';
                    return;
                }
                list.innerHTML = decisions.map(d => {
                    const category = d.category || 'court_decision';
                    const isCourtDecision = category === 'court_decision' || (!category.includes('–ø–ª–µ–Ω—É–º') && !category.includes('–æ–±–∑–æ—Ä') && !category.includes('—Å—Ç–∞—Ç—å—è') && !category.includes('ai_review'));
                    const hasNumber = ['court_decision', 'plenum_resolution', 'practice_review'].includes(category) ||
                                      category.includes('–ø–ª–µ–Ω—É–º') || category.includes('–æ–±–∑–æ—Ä');

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                    let typeIcon = 'üìã';
                    if (category.includes('–ø–ª–µ–Ω—É–º') || category === 'plenum_resolution') typeIcon = '‚öñÔ∏è';
                    else if (category.includes('–æ–±–∑–æ—Ä') || category === 'practice_review') typeIcon = 'üìä';
                    else if (category.includes('—Å—Ç–∞—Ç—å—è') || category === 'scientific_article') typeIcon = 'üìö';
                    else if (category === 'ai_review') typeIcon = 'ü§ñ';

                    // –ú–∞—Ä–∫–µ—Ä –Ω–µ—É—Å—Ç–æ–π–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–¥–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    let penaltyBadge = '';
                    if (isCourtDecision && d.penalty_reduced !== null && d.penalty_reduced !== undefined) {
                        if (d.penalty_reduced) {
                            penaltyBadge = `<span style="background: #FED7D7; color: #C53030; padding: 2px 8px; border-radius: 4px; font-size: 11px;">–°–Ω–∏–∂–µ–Ω–∞${d.reduction_percent ? ' –Ω–∞ ' + d.reduction_percent + '%' : ''}</span>`;
                        } else {
                            penaltyBadge = '<span style="background: #C6F6D5; color: #276749; padding: 2px 8px; border-radius: 4px; font-size: 11px;">–ù–µ —Å–Ω–∏–∂–µ–Ω–∞</span>';
                        }
                    }

                    return `
                    <div style="background: white; border: 1px solid #E1E8ED; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1; cursor: pointer;" onclick="openDocPreview(${d.id})">
                                <span style="margin-right: 5px;">${typeIcon}</span>
                                <strong style="color: #1E3A5F;">${hasNumber && d.case_number ? d.case_number : (d.summary || '').substring(0, 50)}</strong>
                                <span style="color: #8899A6; font-size: 12px; margin-left: 10px;">${d.court_name || ''}</span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="openDocPreview(${d.id})" style="background: none; border: none; color: #3182CE; cursor: pointer; font-size: 14px;" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">‚úèÔ∏è</button>
                                <button onclick="deleteCourtDecision(${d.id})" style="background: none; border: none; color: #E53E3E; cursor: pointer; font-size: 14px;" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                            </div>
                        </div>
                        <div style="color: #4A5568; font-size: 13px; margin-top: 8px; cursor: pointer;" onclick="openDocPreview(${d.id})">${(d.summary || '').substring(0, 150)}${d.summary && d.summary.length > 150 ? '...' : ''}</div>
                        <div style="margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            ${penaltyBadge}
                            ${d.decision_date ? `<span style="color: #8899A6; font-size: 11px;">üìÖ ${d.decision_date}</span>` : ''}
                        </div>
                    </div>
                `}).join('');
            } catch (e) {
                list.innerHTML = `<div style="text-align: center; padding: 20px; color: #E53E3E;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            }
        }

        const DOC_TYPE_NAMES = {
            'court_decision': '–°—É–¥–µ–±–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ',
            'plenum_resolution': '–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–ª–µ–Ω—É–º–∞',
            'practice_review': '–û–±–∑–æ—Ä –ø—Ä–∞–∫—Ç–∏–∫–∏',
            'scientific_article': '–ù–∞—É—á–Ω–∞—è —Å—Ç–∞—Ç—å—è',
            'ai_review': '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä –æ—Ç –ò–ò'
        };

        // –¢–∏–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –Ω–æ–º–µ—Ä–æ–º (—Ä–µ—à–µ–Ω–∏—è, –ø–ª–µ–Ω—É–º—ã, –æ–±–∑–æ—Ä—ã)
        const DOC_TYPES_WITH_NUMBER = ['court_decision', 'plenum_resolution', 'practice_review'];

        function updateKbFormLabels() {
            const docType = document.getElementById('kbDocType').value;
            const penaltyRow = document.getElementById('kbPenaltyRow');
            const caseNumberRow = document.getElementById('kbCaseNumber').closest('.calc-row');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ "–ù–µ—É—Å—Ç–æ–π–∫–∞ —Å–Ω–∏–∂–µ–Ω–∞" —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–¥–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
            penaltyRow.style.display = docType === 'court_decision' ? 'flex' : 'none';

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–π–±–ª—ã
            const labels = {
                'court_decision': {
                    caseNumber: '–ù–æ–º–µ—Ä –¥–µ–ª–∞ *',
                    courtName: '–°—É–¥',
                    date: '–î–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è',
                    keyPoints: '–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'
                },
                'plenum_resolution': {
                    caseNumber: '–ù–æ–º–µ—Ä –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è',
                    courtName: '–û—Ä–≥–∞–Ω',
                    date: '–î–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è',
                    keyPoints: '–ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'
                },
                'practice_review': {
                    caseNumber: '–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞',
                    courtName: '–ö—Ç–æ –∏–∑–¥–∞–ª –æ–±–∑–æ—Ä',
                    date: '–î–∞—Ç–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
                    keyPoints: '–ü—Ä–∞–≤–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'
                },
                'scientific_article': {
                    caseNumber: '–ê–≤—Ç–æ—Ä—ã',
                    courtName: '–ò—Å—Ç–æ—á–Ω–∏–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
                    date: '–ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
                    keyPoints: '–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'
                },
                'ai_review': {
                    caseNumber: '–¢–µ–º–∞/–Ω–∞–∑–≤–∞–Ω–∏–µ',
                    courtName: '–ò—Å—Ç–æ—á–Ω–∏–∫ (ChatGPT, Claude –∏ —Ç.–¥.)',
                    date: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è',
                    keyPoints: '–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)'
                }
            };

            const l = labels[docType] || labels['court_decision'];
            document.getElementById('kbCaseNumberLabel').textContent = l.caseNumber;
            document.getElementById('kbCourtNameLabel').textContent = l.courtName;
            document.getElementById('kbDecisionDateLabel').textContent = l.date;
            document.getElementById('kbKeyPointsLabel').textContent = l.keyPoints;
        }

        async function addCourtDecision() {
            const errorEl = document.getElementById('kbError');
            const successEl = document.getElementById('kbSuccess');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            const docType = document.getElementById('kbDocType').value;
            const caseNumber = document.getElementById('kbCaseNumber').value.trim();
            const summary = document.getElementById('kbSummary').value.trim();

            if (!summary) {
                errorEl.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ';
                errorEl.style.display = 'block';
                return;
            }

            const data = {
                action: 'add',
                doc_type: docType,
                case_number: caseNumber,
                court_name: document.getElementById('kbCourtName').value.trim(),
                decision_date: document.getElementById('kbDecisionDate').value || null,
                summary: summary,
                full_text: document.getElementById('kbFullText').value.trim(),
                key_points: document.getElementById('kbKeyPoints').value.split(',').map(s => s.trim()).filter(s => s),
                penalty_reduced: docType === 'court_decision' ? document.getElementById('kbPenaltyReduced').checked : false,
                reduction_percent: docType === 'court_decision' ? (parseFloat(document.getElementById('kbReductionPercent').value) || null) : null
            };

            try {
                const response = await fetch('/api/knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.error) {
                    errorEl.textContent = result.error;
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = '‚úì ' + DOC_TYPE_NAMES[docType] + ' –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π!';
                    successEl.style.display = 'block';
                    clearKbForm();
                    loadKnowledgeBase();
                }
            } catch (e) {
                errorEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
                errorEl.style.display = 'block';
            }
        }

        async function deleteCourtDecision(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π?')) return;
            try {
                await fetch('/api/knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id: id })
                });
                loadKnowledgeBase();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
            }
        }

        // === Document Preview/Edit Modal ===
        async function openDocPreview(id) {
            const modal = document.getElementById('docPreviewModal');
            const errorEl = document.getElementById('docPreviewError');
            const successEl = document.getElementById('docPreviewSuccess');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            try {
                const response = await fetch('/api/knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get', id: id })
                });
                const result = await response.json();

                if (result.error || !result.document) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: ' + (result.error || '–ù–µ –Ω–∞–π–¥–µ–Ω'));
                    return;
                }

                const doc = result.document;
                document.getElementById('docPreviewId').value = doc.id;
                document.getElementById('docPreviewCategory').value = doc.category || 'court_decision';
                document.getElementById('docPreviewCaseNumber').value = doc.case_number || '';
                document.getElementById('docPreviewCourtName').value = doc.court_name || '';
                document.getElementById('docPreviewSummary').value = doc.summary || '';
                document.getElementById('docPreviewFullText').value = doc.full_text || '';
                document.getElementById('docPreviewKeyPoints').value = (doc.key_points || []).join(', ');

                // –ú–∞—Ä–∫–µ—Ä –Ω–µ—É—Å—Ç–æ–π–∫–∏
                if (doc.penalty_reduced === true) {
                    document.getElementById('docPreviewPenalty').value = 'true';
                } else if (doc.penalty_reduced === false) {
                    document.getElementById('docPreviewPenalty').value = 'false';
                } else {
                    document.getElementById('docPreviewPenalty').value = 'null';
                }
                document.getElementById('docPreviewReductionPercent').value = doc.reduction_percent || '';

                // –°–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('docPreviewFullTextContainer').style.display = 'none';

                modal.style.display = 'flex';
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        function closeDocPreview() {
            document.getElementById('docPreviewModal').style.display = 'none';
        }

        function toggleFullText() {
            const container = document.getElementById('docPreviewFullTextContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        async function saveDocChanges() {
            const id = document.getElementById('docPreviewId').value;
            const errorEl = document.getElementById('docPreviewError');
            const successEl = document.getElementById('docPreviewSuccess');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            const penaltyValue = document.getElementById('docPreviewPenalty').value;
            let penaltyReduced = null;
            if (penaltyValue === 'true') penaltyReduced = true;
            else if (penaltyValue === 'false') penaltyReduced = false;

            const data = {
                action: 'update',
                id: parseInt(id),
                category: document.getElementById('docPreviewCategory').value,
                case_number: document.getElementById('docPreviewCaseNumber').value.trim(),
                court_name: document.getElementById('docPreviewCourtName').value.trim(),
                summary: document.getElementById('docPreviewSummary').value.trim(),
                key_points: document.getElementById('docPreviewKeyPoints').value.split(',').map(s => s.trim()).filter(s => s),
                penalty_reduced: penaltyReduced,
                reduction_percent: parseFloat(document.getElementById('docPreviewReductionPercent').value) || null
            };

            try {
                const response = await fetch('/api/knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.error) {
                    errorEl.textContent = result.error;
                    errorEl.style.display = 'block';
                } else {
                    successEl.textContent = '‚úì –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                    successEl.style.display = 'block';
                    loadKnowledgeBase();
                    setTimeout(() => closeDocPreview(), 1000);
                }
            } catch (e) {
                errorEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
                errorEl.style.display = 'block';
            }
        }

        function clearKbForm() {
            document.getElementById('kbDocType').value = 'court_decision';
            document.getElementById('kbCaseNumber').value = '';
            document.getElementById('kbCourtName').value = '';
            document.getElementById('kbDecisionDate').value = '';
            document.getElementById('kbSummary').value = '';
            document.getElementById('kbFullText').value = '';
            document.getElementById('kbKeyPoints').value = '';
            document.getElementById('kbPenaltyReduced').checked = false;
            document.getElementById('kbReductionPercent').value = '';
            document.getElementById('kbDocumentFile').value = '';
            document.getElementById('kbParseStatus').textContent = '';
            document.getElementById('kbError').style.display = 'none';
            document.getElementById('kbSuccess').style.display = 'none';
            updateKbFormLabels();
        }

        async function parseKbDocument() {
            const fileInput = document.getElementById('kbDocumentFile');
            const statusEl = document.getElementById('kbParseStatus');
            const parseBtn = document.getElementById('kbParseBtn');
            const errorEl = document.getElementById('kbError');
            const docType = document.getElementById('kbDocType').value;

            errorEl.style.display = 'none';

            if (!fileInput.files || !fileInput.files[0]) {
                statusEl.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
                statusEl.style.color = '#E53E3E';
                return;
            }

            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();

            parseBtn.disabled = true;
            statusEl.textContent = '‚è≥ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞...';
            statusEl.style.color = '#8899A6';

            try {
                let documentText = '';

                if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                    // DOCX: –∏—Å–ø–æ–ª—å–∑—É–µ–º mammoth
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    documentText = result.value;
                } else if (fileName.endsWith('.pdf')) {
                    // PDF: –∏—Å–ø–æ–ª—å–∑—É–µ–º pdf.js
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const textParts = [];
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        textParts.push(pageText);
                    }
                    documentText = textParts.join('\n\n');
                } else {
                    throw new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PDF –∏–ª–∏ DOCX.');
                }

                if (!documentText || documentText.trim().length < 100) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.');
                }

                statusEl.textContent = 'ü§ñ AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç ' + DOC_TYPE_NAMES[docType].toLowerCase() + '...';

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ AI —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–∏–ø–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                const response = await fetch('/api/knowledge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'parse',
                        doc_type: docType,
                        text: documentText
                    })
                });

                const result = await response.json();

                if (result.error) {
                    throw new Error(result.error);
                }

                if (!result.success || !result.data) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
                }

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                const data = result.data;
                // –ù–æ–º–µ—Ä –¥–µ–ª–∞/–¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–ª–∏ –∞–≤—Ç–æ—Ä—ã
                if (data.case_number) document.getElementById('kbCaseNumber').value = data.case_number;
                else if (data.document_number) document.getElementById('kbCaseNumber').value = data.document_number;
                else if (data.authors) document.getElementById('kbCaseNumber').value = data.authors;
                // –°—É–¥/–∏—Å—Ç–æ—á–Ω–∏–∫
                if (data.court_name) document.getElementById('kbCourtName').value = data.court_name;
                else if (data.source) document.getElementById('kbCourtName').value = data.source;

                if (data.decision_date) document.getElementById('kbDecisionDate').value = data.decision_date;

                // –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ (—Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å)
                let summaryText = '';
                if (data.title) summaryText = data.title + '. ';
                if (data.summary) summaryText += data.summary;
                if (summaryText) document.getElementById('kbSummary').value = summaryText;

                // –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏
                let keyPoints = [];
                if (data.key_points && Array.isArray(data.key_points)) keyPoints = keyPoints.concat(data.key_points);
                if (data.practical_conclusions && Array.isArray(data.practical_conclusions)) keyPoints = keyPoints.concat(data.practical_conclusions);
                if (keyPoints.length > 0) {
                    document.getElementById('kbKeyPoints').value = keyPoints.join(', ');
                }

                // –¢–æ–ª—å–∫–æ –¥–ª—è —Å—É–¥–µ–±–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
                if (docType === 'court_decision') {
                    if (data.penalty_reduced) document.getElementById('kbPenaltyReduced').checked = true;
                    if (data.reduction_percent) document.getElementById('kbReductionPercent').value = data.reduction_percent;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
                document.getElementById('kbFullText').value = documentText.substring(0, 50000);

                statusEl.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –±–∞–∑—É.';
                statusEl.style.color = '#38A169';

            } catch (e) {
                statusEl.textContent = '';
                errorEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
                errorEl.style.display = 'block';
            } finally {
                parseBtn.disabled = false;
            }
        }

        // === –°–∂–∞—Ç–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ ===
        function compressText(text) {
            if (!text) return '';
            return text
                .replace(/\r\n/g, '\n')
                .replace(/\n{3,}/g, '\n\n')
                .replace(/[ \t]{2,}/g, ' ')
                .replace(/^[ \t]+/gm, '')
                .replace(/[ \t]+$/gm, '')
                .trim();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadRates(); loadHistory(); loadTemplates(); updateStats(); loadDraft(); loadComparisonSelectors();
            setInterval(saveDraft, 30000);
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('calcEndDate').value = today;
            document.getElementById('calcEndDatePeriods').value = today;
        });

        function switchMainTab(tabName) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`.main-tab[onclick="switchMainTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ —ç—Ç—É –≤–∫–ª–∞–¥–∫—É
            if (tabName === 'knowledge') loadKnowledgeBase();
        }

        function selectModel(el) {
            document.querySelectorAll('.model-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedModel = el.dataset.model;
        }

        async function loadRates() {
            try {
                const response = await fetchWithTimeout('/api/rates', {}, 10000);
                if (response.ok) {
                    const data = await response.json();
                    cachedRates = data.history || [];
                    currentRate = data.current;
                    if (currentRate) {
                        document.getElementById('ratesContainer').innerHTML = `<div style="font-size: 24px; font-weight: 700; color: #1E3A5F;">${currentRate.key_rate}%</div><div style="font-size: 11px; color: #8899A6;">—Å ${formatDate(currentRate.date_from)}</div>`;
                    }
                }
            } catch (e) { document.getElementById('ratesContainer').innerHTML = '<div style="color: #C53030;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
        }

        function formatDate(d) { return new Date(d).toLocaleDateString('ru-RU'); }

        function switchTab(docType, tabType, btn) {
            btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`${docType}-file-tab`).classList.remove('active');
            document.getElementById(`${docType}-text-tab`).classList.remove('active');
            document.getElementById(`${docType}-${tabType}-tab`).classList.add('active');
        }

        function handleMultiFileSelect(input, docType) {
            const files = Array.from(input.files);
            const currentFiles = docType === 'claim' ? claimFiles : responseFiles;
            for (const file of files) {
                if (currentFiles.length >= MAX_FILES) { alert(`–ú–∞–∫—Å–∏–º—É–º ${MAX_FILES} —Ñ–∞–π–ª–∞`); break; }
                if (file.size > MAX_FILE_SIZE) { alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)`); continue; }
                if (docType === 'claim') claimFiles.push(file); else responseFiles.push(file);
            }
            updateFileList(docType);
            input.value = '';
        }

        function handleCameraCapture(input, docType) {
            if (input.files && input.files[0]) {
                const currentFiles = docType === 'claim' ? claimFiles : responseFiles;
                if (currentFiles.length >= MAX_FILES) { alert(`–ú–∞–∫—Å–∏–º—É–º ${MAX_FILES} —Ñ–∞–π–ª–∞`); return; }
                const file = input.files[0];
                if (file.size > MAX_FILE_SIZE) { alert(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π`); return; }
                if (docType === 'claim') claimFiles.push(file); else responseFiles.push(file);
                updateFileList(docType);
            }
            input.value = '';
        }

        function removeFile(docType, index) {
            const files = docType === 'claim' ? claimFiles : responseFiles;
            const file = files[index];
            if (file) revokeFileObjectUrl(file);  // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
            if (docType === 'claim') claimFiles.splice(index, 1); else responseFiles.splice(index, 1);
            updateFileList(docType);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' –ë';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' –ö–ë';
            return (bytes / (1024 * 1024)).toFixed(1) + ' –ú–ë';
        }

        function updateFileList(docType) {
            const files = docType === 'claim' ? claimFiles : responseFiles;
            const listEl = document.getElementById(`${docType}-file-list`);
            const uploadArea = document.getElementById(`${docType}-upload-area`);
            if (files.length === 0) {
                listEl.innerHTML = '';
                uploadArea.classList.remove('has-file');
            } else {
                const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                const header = `
                    <div class="file-list-header">
                        <span>${files.length} —Ñ–∞–π–ª(–æ–≤), ${formatFileSize(totalSize)}</span>
                        <button class="clear-all-files" onclick="clearAllFiles('${docType}')">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                    </div>
                `;
                const items = files.map((file, i) => {
                    const isImage = file.type.startsWith('image/');
                    const objectUrl = isImage ? getOrCreateObjectUrl(file) : '';
                    const preview = isImage
                        ? `<img src="${objectUrl}"><span class="zoom-hint">üîç</span>`
                        : getFileIcon(file.name);
                    const clickHandler = isImage
                        ? `onclick="openImagePreview('${objectUrl}', '${file.name.replace(/'/g, "\\'")}'); event.stopPropagation();"`
                        : '';
                    const clickableClass = isImage ? 'clickable' : '';
                    return `<div class="file-item"><div class="file-preview ${clickableClass}" ${clickHandler}>${preview}</div><div class="file-info"><div class="file-name" title="${file.name}">${file.name}</div><div class="file-size">${formatFileSize(file.size)}</div></div><button class="remove-file" onclick="removeFile('${docType}', ${i})" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª">‚úï</button></div>`;
                }).join('');
                listEl.innerHTML = header + items;
                uploadArea.classList.add('has-file');
            }
        }

        function clearAllFiles(docType) {
            if (docType === 'claim') {
                revokeAllObjectUrls(claimFiles);  // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                claimFiles = [];
            } else {
                revokeAllObjectUrls(responseFiles);  // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                responseFiles = [];
            }
            updateFileList(docType);
        }

        function openImagePreview(src, filename) {
            document.getElementById('imagePreviewImg').src = src;
            document.getElementById('imagePreviewFilename').textContent = filename;
            document.getElementById('imagePreviewModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImagePreview() {
            document.getElementById('imagePreviewModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            if (['jpg', 'jpeg', 'png', 'heic'].includes(ext)) return 'üñºÔ∏è';
            if (ext === 'pdf') return 'üìï';
            if (['doc', 'docx'].includes(ext)) return 'üìò';
            return 'üìÑ';
        }

        async function readFileContent(file, statusCallback) {
            const ext = file.name.toLowerCase().split('.').pop();
            if (ext === 'docx' || ext === 'doc') { if (statusCallback) statusCallback(`–ß–∏—Ç–∞—é ${file.name}...`); return await readDocx(file); }
            if (ext === 'pdf') { if (statusCallback) statusCallback(`–ò–∑–≤–ª–µ–∫–∞—é —Ç–µ–∫—Å—Ç –∏–∑ ${file.name}...`); return await readPdf(file); }
            if (['jpg', 'jpeg', 'png', 'heic'].includes(ext)) { if (statusCallback) statusCallback(`–†–∞—Å–ø–æ–∑–Ω–∞—é —Ç–µ–∫—Å—Ç –Ω–∞ ${file.name}...`); return await recognizeImage(file); }
            return await readTextFile(file);
        }

        async function readDocx(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => { try { resolve((await mammoth.extractRawText({ arrayBuffer: e.target.result })).value); } catch (err) { reject(err); } };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function readPdf(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const pdfData = e.target.result;
                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        let text = '';

                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –Ω–∞–ø—Ä—è–º—É—é
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(' ') + '\n\n';
                        }

                        // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –º–∞–ª–æ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Å–∫–∞–Ω), –∏—Å–ø–æ–ª—å–∑—É–µ–º OCR
                        const avgCharsPerPage = text.trim().length / pdf.numPages;
                        if (avgCharsPerPage < 100) {
                            console.log(`PDF "${file.name}": –º–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ (${avgCharsPerPage.toFixed(0)} —Å–∏–º–≤/—Å—Ç—Ä), –∑–∞–ø—É—Å–∫–∞—é OCR...`);
                            text = await ocrPdfPages(pdf, file.name);
                        }

                        resolve(text.trim());
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function ocrPdfPages(pdf, filename) {
            const texts = [];
            const scale = 2.0; // –ú–∞—Å—à—Ç–∞–± –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ OCR

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale });

                // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ canvas
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: context, viewport }).promise;

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ OCR
                const imageData = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];

                try {
                    const response = await fetchWithTimeout('/api/ocr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageData, filename: `${filename}_page${i}.jpg` })
                    }, 30000);
                    const result = await response.json();
                    if (response.ok && result.text) {
                        texts.push(`--- –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${i} ---\n${result.text}`);
                    }
                } catch (err) {
                    console.warn(`OCR —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${i} –Ω–µ —É–¥–∞–ª—Å—è:`, err);
                    texts.push(`--- –°—Ç—Ä–∞–Ω–∏—Ü–∞ ${i} ---\n[–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è]`);
                }
            }

            return texts.join('\n\n');
        }

        async function readTextFile(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = reject; reader.readAsText(file, 'UTF-8'); }); }

        async function recognizeImage(file) {
            let imageData = await fileToBase64(file);
            if (file.size > 2 * 1024 * 1024) imageData = await compressImage(imageData);
            const response = await fetchWithTimeout('/api/ocr', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: imageData, filename: file.name }) }, 30000);
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞ OCR');
            return result.text;
        }

        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); }

        async function compressImage(base64) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 1600;
                    let { width, height } = img;
                    if (width > height && width > maxSize) { height = (height * maxSize) / width; width = maxSize; } else if (height > maxSize) { width = (width * maxSize) / height; height = maxSize; }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                img.src = 'data:image/jpeg;base64,' + base64;
            });
        }

        let progressState = { totalFiles: 0, processedFiles: 0, currentFile: '' };

        function setProgress(step, percent, text, substepText = '', details = {}) {
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;

            // Update steps visualization
            document.querySelectorAll('.progress-step').forEach(el => {
                const stepNum = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (stepNum < step) el.classList.add('completed');
                if (stepNum === step) el.classList.add('active');
            });

            // Update substep text
            for (let i = 1; i <= 4; i++) {
                const substepEl = document.getElementById(`substep-${i}`);
                if (substepEl) substepEl.textContent = i === step ? substepText : '';
            }

            // Update elapsed time
            if (generationStartTime) {
                document.getElementById('progressTime').textContent = `–ü—Ä–æ—à–ª–æ: ${((Date.now() - generationStartTime) / 1000).toFixed(1)} —Å–µ–∫.`;
            }

            // Update progress details
            const detailsEl = document.getElementById('progressDetails');
            if (details.showDetails) {
                detailsEl.style.display = 'block';
                if (details.filesTotal !== undefined) {
                    document.getElementById('filesProcessed').textContent = `${details.filesProcessed || 0} / ${details.filesTotal}`;
                }
                if (details.stage) {
                    document.getElementById('currentStage').textContent = details.stage;
                }
            }
        }

        function hideProgress() {
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('progressDetails').style.display = 'none';
            for (let i = 1; i <= 4; i++) {
                const substepEl = document.getElementById(`substep-${i}`);
                if (substepEl) substepEl.textContent = '';
            }
        }

        async function processAllFiles(files, statusCallback) {
            const texts = [];
            for (const file of files) { try { const text = await readFileContent(file, statusCallback); if (text && text.trim()) texts.push(`--- ${file.name} ---\n${text}`); } catch (err) { texts.push(`--- ${file.name} ---\n[–û—à–∏–±–∫–∞: ${err.message}]`); } }
            return texts.join('\n\n');
        }

        async function generateArguments(useModel = null) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorBox');
            const actionButtons = document.getElementById('actionButtons');
            const outputBadges = document.getElementById('outputBadges');
            const modelToUse = useModel || selectedModel;
            generationStartTime = Date.now();

            let finalClaimText = document.getElementById('claimText').value;
            let finalResponseText = document.getElementById('responseText').value;
            const userComments = document.getElementById('userComments').value;

            analyzeBtn.disabled = true;
            output.style.display = 'none';
            errorBox.classList.remove('active');
            actionButtons.style.display = 'none';
            outputBadges.style.display = 'none';

            try {
                const totalFiles = claimFiles.length + responseFiles.length;
                let processedFiles = 0;
                const hasImages = [...claimFiles, ...responseFiles].some(f => f.type.startsWith('image/'));

                // Step 1: Reading files
                setProgress(1, 5, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —á—Ç–µ–Ω–∏—é —Ñ–∞–π–ª–æ–≤...', '', { showDetails: totalFiles > 0, filesTotal: totalFiles, filesProcessed: 0, stage: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è' });

                if (claimFiles.length > 0) {
                    for (let i = 0; i < claimFiles.length; i++) {
                        const file = claimFiles[i];
                        const isImage = file.type.startsWith('image/');
                        const stepNum = isImage ? 2 : 1;
                        const stepLabel = isImage ? 'OCR' : '–ß—Ç–µ–Ω–∏–µ';
                        const progress = 5 + ((i + 1) / totalFiles) * 35;

                        setProgress(stepNum, progress, `${stepLabel}: ${file.name}`, file.name.substring(0, 20) + (file.name.length > 20 ? '...' : ''), {
                            showDetails: true,
                            filesTotal: totalFiles,
                            filesProcessed: processedFiles,
                            stage: isImage ? '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)' : '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞'
                        });

                        try {
                            const text = await readFileContent(file, null);
                            if (text && text.trim()) finalClaimText += `\n\n--- ${file.name} ---\n${text}`;
                        } catch (err) {
                            finalClaimText += `\n\n--- ${file.name} ---\n[–û—à–∏–±–∫–∞: ${err.message}]`;
                        }
                        processedFiles++;
                    }
                }

                if (responseFiles.length > 0) {
                    for (let i = 0; i < responseFiles.length; i++) {
                        const file = responseFiles[i];
                        const isImage = file.type.startsWith('image/');
                        const stepNum = isImage ? 2 : 1;
                        const stepLabel = isImage ? 'OCR' : '–ß—Ç–µ–Ω–∏–µ';
                        const progress = 40 + ((i + 1) / responseFiles.length) * 15;

                        setProgress(stepNum, progress, `${stepLabel} –æ—Ç–∑—ã–≤–∞: ${file.name}`, file.name.substring(0, 20) + (file.name.length > 20 ? '...' : ''), {
                            showDetails: true,
                            filesTotal: totalFiles,
                            filesProcessed: processedFiles,
                            stage: isImage ? '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)' : '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞'
                        });

                        try {
                            const text = await readFileContent(file, null);
                            if (text && text.trim()) finalResponseText += `\n\n--- ${file.name} ---\n${text}`;
                        } catch (err) {
                            finalResponseText += `\n\n--- ${file.name} ---\n[–û—à–∏–±–∫–∞: ${err.message}]`;
                        }
                        processedFiles++;
                    }
                }

                if (!finalClaimText.trim()) throw new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å–∫ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ —Ç–µ–∫—Å—Ç');

                // –°–∂–∞—Ç–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
                finalClaimText = compressText(finalClaimText);
                finalResponseText = compressText(finalResponseText);

                lastInputData = { claim_text: finalClaimText, response_text: finalResponseText, user_comments: userComments };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
                setProgress(3, 55, `–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞...`, '', { showDetails: false });
                const cached = await getCachedResult(finalClaimText, finalResponseText, modelToUse);

                let argumentsText, actualModel;

                if (cached) {
                    // –ù–∞–π–¥–µ–Ω –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                    setProgress(4, 100, '–ì–æ—Ç–æ–≤–æ! (–∏–∑ –∫—ç—à–∞)', '–ö—ç—à', { showDetails: false });
                    argumentsText = cached.result;
                    actualModel = cached.modelUsed;
                    console.log('üí∞ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à - API –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è');
                } else {
                    // Step 3: AI Generation
                    setProgress(3, 60, `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤...`, MODEL_NAMES[modelToUse], {
                        showDetails: true,
                        filesTotal: totalFiles,
                        filesProcessed: processedFiles,
                        stage: `–ú–æ–¥–µ–ª—å: ${MODEL_NAMES[modelToUse]}`
                    });

                    const ratesInfo = currentRate ? `–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§: ${currentRate.key_rate}% (—Å ${currentRate.date_from})` : '';
                    // Vercel Pro –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ 300 —Å–µ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
                    const apiTimeout = 300000;  // 5 –º–∏–Ω—É—Ç –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
                    const response = await fetchWithTimeout('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ claim_text: finalClaimText, response_text: finalResponseText, other_documents: '', user_comments: userComments, rates_info: ratesInfo, model: modelToUse }) }, apiTimeout);

                    setProgress(3, 85, '–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI...', '–û–±—Ä–∞–±–æ—Ç–∫–∞', { showDetails: true, filesTotal: totalFiles, filesProcessed: processedFiles, stage: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞' });
                    if (!response.ok) { const errText = await response.text(); if (errText.includes('TIMEOUT') || errText.includes('timeout')) throw new Error('‚è±Ô∏è –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'); try { const err = JSON.parse(errText); throw new Error(err.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); } catch(e) { if (e.message.includes('–û—à–∏–±–∫–∞') || e.message.includes('‚è±Ô∏è')) throw e; throw new Error(errText.substring(0, 200) || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); } }
                    const result = await response.json();

                    argumentsText = result.arguments_text;
                    actualModel = result.model_used || modelToUse;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    await setCachedResult(finalClaimText, finalResponseText, modelToUse, argumentsText, actualModel);
                    setProgress(4, 100, '–ì–æ—Ç–æ–≤–æ!', '–£—Å–ø–µ—à–Ω–æ', { showDetails: false });
                }

                const generationTime = ((Date.now() - generationStartTime) / 1000).toFixed(1);

                setTimeout(() => {
                    hideProgress();
                    lastResult = argumentsText;
                    lastUsedModel = actualModel;
                    document.getElementById('modelBadge').textContent = (cached ? 'üíæ ' : '') + (MODEL_NAMES[lastUsedModel] || lastUsedModel);
                    document.getElementById('timeBadge').textContent = `‚è±Ô∏è ${generationTime} —Å–µ–∫.` + (cached ? ' (–∫—ç—à)' : '');
                    outputBadges.style.display = 'block';
                    output.innerHTML = formatOutputHtml(argumentsText);
                    output.classList.remove('output-empty');
                    output.style.display = 'block';
                    actionButtons.style.display = 'flex';
                    saveToHistory(argumentsText, lastUsedModel, generationTime);
                    updateStatsAfterGeneration(lastUsedModel, parseFloat(generationTime));
                }, 500);
            } catch (error) {
                hideProgress();
                let msg = error.message;
                if (msg === 'Failed to fetch' || msg.includes('NetworkError')) msg = '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.';
                errorBox.textContent = '‚ùå ' + msg;
                errorBox.classList.add('active');
                output.style.display = 'block';
            } finally { analyzeBtn.disabled = false; }
        }

        function regenerateWithDifferentModel() {
            if (!lastInputData) { alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã'); return; }
            // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.querySelectorAll('#modelSelectModal .model-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.model === lastUsedModel);
            });
            document.getElementById('modelSelectModal').classList.add('active');
        }

        function closeModelSelectModal() {
            document.getElementById('modelSelectModal').classList.remove('active');
        }

        function selectAndRegenerate(modelId) {
            closeModelSelectModal();
            document.querySelectorAll('.model-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.model === modelId));
            selectedModel = modelId;
            generateWithSavedData(modelId);
        }

        async function generateWithSavedData(modelToUse) {
            if (!lastInputData) return;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorBox');
            const actionButtons = document.getElementById('actionButtons');
            const outputBadges = document.getElementById('outputBadges');

            analyzeBtn.disabled = true;
            generationStartTime = Date.now();
            setProgress(3, 30, `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è (${MODEL_NAMES[modelToUse]})...`);
            output.style.display = 'none';
            errorBox.classList.remove('active');
            actionButtons.style.display = 'none';

            try {
                const ratesInfo = currentRate ? `–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§: ${currentRate.key_rate}%` : '';
                // Vercel Pro –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ 300 —Å–µ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
                const apiTimeout = 300000;  // 5 –º–∏–Ω—É—Ç –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
                const response = await fetchWithTimeout('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...lastInputData, other_documents: '', rates_info: ratesInfo, model: modelToUse }) }, apiTimeout);
                setProgress(3, 80, '–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...', MODEL_NAMES[modelToUse], { showDetails: true, filesTotal: 0, filesProcessed: 0, stage: '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞' });
                if (!response.ok) { const errText = await response.text(); if (errText.includes('TIMEOUT') || errText.includes('timeout')) throw new Error('‚è±Ô∏è –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'); try { const err = JSON.parse(errText); throw new Error(err.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); } catch(e) { if (e.message.includes('–û—à–∏–±–∫–∞') || e.message.includes('‚è±Ô∏è')) throw e; throw new Error(errText.substring(0, 200) || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'); } }
                const result = await response.json();

                setProgress(4, 100, '–ì–æ—Ç–æ–≤–æ!', '–£—Å–ø–µ—à–Ω–æ', { showDetails: false });
                const generationTime = ((Date.now() - generationStartTime) / 1000).toFixed(1);
                setTimeout(() => {
                    hideProgress();
                    lastResult = result.arguments_text;
                    lastUsedModel = result.model_used || modelToUse;
                    document.getElementById('modelBadge').textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                    document.getElementById('timeBadge').textContent = `‚è±Ô∏è ${generationTime} —Å–µ–∫.`;
                    outputBadges.style.display = 'block';
                    output.innerHTML = formatOutputHtml(result.arguments_text);
                    output.classList.remove('output-empty');
                    output.style.display = 'block';
                    actionButtons.style.display = 'flex';
                    saveToHistory(result.arguments_text, lastUsedModel, generationTime);
                    updateStatsAfterGeneration(lastUsedModel, parseFloat(generationTime));
                }, 500);
            } catch (error) {
                hideProgress();
                let msg = error.message;
                if (msg === 'Failed to fetch' || msg.includes('NetworkError')) msg = '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.';
                errorBox.textContent = '‚ùå ' + msg;
                errorBox.classList.add('active');
                output.style.display = 'block';
            } finally { analyzeBtn.disabled = false; }
        }

        // Comparison functions - compare results from history
        function loadComparisonSelectors() {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const select1 = document.getElementById('compare1');
            const select2 = document.getElementById('compare2');
            const noHistoryMsg = document.getElementById('noHistoryMessage');
            const container = document.getElementById('comparisonContainer');

            if (history.length < 2) {
                noHistoryMsg.style.display = 'block';
                container.classList.remove('active');
                select1.innerHTML = '<option value="">-- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ --</option>';
                select2.innerHTML = '<option value="">-- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ --</option>';
                return;
            }

            noHistoryMsg.style.display = 'none';

            const options = history.map((item, i) => {
                const date = formatDate(item.date);
                const model = item.model ? (MODEL_NAMES[item.model] || item.model) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const preview = item.preview.substring(0, 50) + '...';
                return `<option value="${i}">${date} - ${model}: ${preview}</option>`;
            }).join('');

            select1.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>' + options;
            select2.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ --</option>' + options;
        }

        function updateComparisonPreview(num) {
            const select = document.getElementById(`compare${num}`);
            const index = select.value;
            const header = document.getElementById(`header-${num}`);
            const content = document.getElementById(`content-${num}`);

            if (index === '') {
                header.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç ${num}`;
                content.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ';
                return;
            }

            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const item = history[index];
            if (item) {
                const model = item.model ? (MODEL_NAMES[item.model] || item.model) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                header.textContent = `${formatDate(item.date)} - ${model}`;
                content.textContent = item.text;
            }
        }

        function runHistoryComparison() {
            const index1 = document.getElementById('compare1').value;
            const index2 = document.getElementById('compare2').value;

            if (index1 === '' || index2 === '') {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
                return;
            }

            if (index1 === index2) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
                return;
            }

            document.getElementById('comparisonContainer').classList.add('active');
            updateComparisonPreview(1);
            updateComparisonPreview(2);
        }

        function toggleEdit() {
            const output = document.getElementById('output');
            isEditing = !isEditing;
            output.contentEditable = isEditing;
            output.classList.toggle('output-editable', isEditing);
            if (isEditing) output.focus(); else lastResult = output.textContent;
        }

        function clearForm() {
            claimFiles = []; responseFiles = [];
            updateFileList('claim'); updateFileList('response');
            ['claimText', 'responseText', 'userComments'].forEach(id => document.getElementById(id).value = '');
            const output = document.getElementById('output');
            output.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª';
            output.classList.add('output-empty');
            output.contentEditable = false;
            isEditing = false;
            document.getElementById('errorBox').classList.remove('active');
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('outputBadges').style.display = 'none';
            lastInputData = null;
            localStorage.removeItem('draft');
        }

        function formatOutputHtml(text) {
            const lines = text.split('\n');
            let html = '';
            let isFirstHeading = true;
            let subtitleLines = [];
            let collectingSubtitle = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) {
                    if (collectingSubtitle && subtitleLines.length > 0) {
                        html += `<div class="doc-subtitle">${subtitleLines.join('<br>')}</div>`;
                        subtitleLines = [];
                        collectingSubtitle = false;
                    }
                    continue;
                }

                const isDocTitle = isFirstHeading && /^[–ê-–Ø–ÅA-Z\s]+$/.test(line) && line.length > 5;
                const isMainHeading = /^\d+\.\s+[–ê-–Ø–ÅA-Z\s]+$/.test(line);
                const isSubHeading = /^\d+\.\d+\.?\s+/.test(line);

                if (isDocTitle) {
                    isFirstHeading = false;
                    collectingSubtitle = true;
                    html += `<div class="doc-title">${line}</div>`;
                    html += `<div class="doc-title-line">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>`;
                } else if (collectingSubtitle && !isMainHeading) {
                    subtitleLines.push(line);
                } else if (isMainHeading) {
                    if (subtitleLines.length > 0) {
                        html += `<div class="doc-subtitle">${subtitleLines.join('<br>')}</div>`;
                        subtitleLines = [];
                    }
                    collectingSubtitle = false;
                    isFirstHeading = false;
                    html += `<div class="section-heading">${line}</div>`;
                } else if (isSubHeading) {
                    html += `<div class="subsection-heading">${line}</div>`;
                } else {
                    html += `<div class="paragraph">${line}</div>`;
                }
            }

            if (subtitleLines.length > 0) {
                html += `<div class="doc-subtitle">${subtitleLines.join('<br>')}</div>`;
            }

            return html;
        }

        function copyToClipboard() { navigator.clipboard.writeText(lastResult || document.getElementById('output').innerText).then(() => alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!')); }

        async function downloadDocx() {
            const { Document, Packer, Paragraph, TextRun, AlignmentType, ImageRun, Footer, PageNumber } = docx;
            const text = lastResult || document.getElementById('output').innerText;
            const lines = text.split('\n');
            const children = [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–æ
            let logoData = null;
            try {
                const response = await fetch('/icon-192.png');
                const blob = await response.blob();
                logoData = await blob.arrayBuffer();
            } catch (e) {
                console.warn('Could not load logo for DOCX:', e);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–æ –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (logoData) {
                children.push(
                    new Paragraph({
                        children: [
                            new ImageRun({
                                data: logoData,
                                transformation: { width: 18, height: 18 },
                                type: 'png'
                            }),
                            new TextRun({ text: " " }),
                            new TextRun({ text: "Anti", bold: true, size: 20, color: "1a2744" }),
                            new TextRun({ text: "333", bold: true, size: 20, color: "C9A227" }),
                            new TextRun({ text: ".AI", bold: true, size: 20, color: "1a2744" }),
                        ],
                        spacing: { after: 150 }
                    })
                );
            } else {
                children.push(
                    new Paragraph({
                        children: [
                            new TextRun({ text: "Anti", bold: true, size: 20, color: "1a2744" }),
                            new TextRun({ text: "333", bold: true, size: 20, color: "C9A227" }),
                            new TextRun({ text: ".AI", bold: true, size: 20, color: "1a2744" }),
                        ],
                        spacing: { after: 150 }
                    })
                );
            }

            let isFirstHeading = true;
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

                // –ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
                const isDocTitle = isFirstHeading && /^[–ê-–Ø–ÅA-Z\s]+$/.test(trimmed) && trimmed.length > 5;
                const isMainHeading = /^\d+\.\s+[–ê-–Ø–ÅA-Z\s]+$/.test(trimmed);
                const isSubHeading = /^\d+\.\d+\.?\s+/.test(trimmed);

                if (isDocTitle) {
                    isFirstHeading = false;
                    // –ö—Ä–∞—Å–∏–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                    children.push(new Paragraph({
                        children: [new TextRun({ text: trimmed, bold: true, size: 32, color: "1a2744" })],
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 100, after: 60 }
                    }));
                    // –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
                    children.push(new Paragraph({
                        children: [new TextRun({ text: "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", color: "C9A227", size: 16 })],
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }));
                } else if (isMainHeading) {
                    isFirstHeading = false;
                    // –ü—Ä–æ–±–µ–ª –ø–µ—Ä–µ–¥ —Ä–∞–∑–¥–µ–ª–æ–º
                    children.push(new Paragraph({ text: '', spacing: { after: 120 } }));
                    children.push(new Paragraph({ children: [new TextRun({ text: trimmed, bold: true, size: 26, color: "1a2744" })], spacing: { before: 100, after: 100 } }));
                } else if (isSubHeading) {
                    children.push(new Paragraph({ children: [new TextRun({ text: trimmed, bold: true, size: 24, color: "1a2744" })], spacing: { before: 160, after: 80 } }));
                } else {
                    children.push(new Paragraph({ children: [new TextRun({ text: trimmed, size: 24 })], spacing: { after: 60 }, alignment: AlignmentType.JUSTIFIED }));
                }
            }
            const doc = new Document({
                sections: [{
                    properties: { page: { margin: { top: 900, right: 1000, bottom: 900, left: 1701 } } },
                    footers: {
                        default: new Footer({
                            children: [
                                new Paragraph({
                                    children: [new TextRun({ children: [PageNumber.CURRENT], size: 20, color: "808080" })],
                                    alignment: AlignmentType.CENTER
                                })
                            ]
                        })
                    },
                    children
                }]
            });
            saveAs(await Packer.toBlob(doc), generateFileName('docx'));
        }

        function saveToHistory(fullText, model, time) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            history.unshift({ date: new Date().toISOString(), preview: fullText.substring(0, 100).replace(/[\r\n]+/g, ' '), text: fullText, model, time });
            if (history.length > 10) history.pop();
            localStorage.setItem('argumentsHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                section.style.display = 'none';
                loadComparisonSelectors();
                return;
            }
            section.style.display = 'block';
            list.innerHTML = history.map((item, i) => `
                <div class="history-item">
                    <div class="history-content" onclick="loadFromHistory(${i})">
                        <div class="date">${formatDate(item.date)} ${item.model ? '‚Ä¢ ' + (MODEL_NAMES[item.model] || item.model) : ''}${item.time ? ' ‚Ä¢ ‚è±Ô∏è ' + item.time + ' —Å–µ–∫.' : ''}</div>
                        <div class="preview">${item.preview}...</div>
                    </div>
                    <button class="delete-history" onclick="event.stopPropagation(); deleteFromHistory(${i})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
                </div>
            `).join('');
            loadComparisonSelectors();
        }

        function deleteFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            if (index >= 0 && index < history.length) {
                history.splice(index, 1);
                localStorage.setItem('argumentsHistory', JSON.stringify(history));
                loadHistory();
            }
        }

        function clearAllHistory() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤?')) {
                localStorage.removeItem('argumentsHistory');
                loadHistory();
            }
        }

        function loadFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            if (history[index]) {
                lastResult = history[index].text;
                lastUsedModel = history[index].model || '';
                const output = document.getElementById('output');
                output.innerHTML = formatOutputHtml(history[index].text);
                output.classList.remove('output-empty');
                output.style.display = 'block';
                document.getElementById('actionButtons').style.display = 'flex';
                document.getElementById('modelBadge').textContent = 'üìú ' + (MODEL_NAMES[lastUsedModel] || lastUsedModel || '–ò—Å—Ç–æ—Ä–∏—è');
                document.getElementById('timeBadge').textContent = history[index].time ? `‚è±Ô∏è ${history[index].time} —Å–µ–∫.` : '';
                document.getElementById('outputBadges').style.display = 'block';
            }
        }

        function loadTemplates() {
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            const grid = document.getElementById('templateGrid');
            const noTemplates = document.getElementById('noTemplates');
            if (templates.length === 0) { grid.innerHTML = ''; noTemplates.style.display = 'block'; return; }
            noTemplates.style.display = 'none';
            grid.innerHTML = templates.map((t, i) => `<div class="template-card" onclick="useTemplate(${i})"><h4>${t.name}</h4><p>${t.description}</p><div class="template-tags">${t.tags.map(tag => `<span class="template-tag">${tag}</span>`).join('')}</div><button class="btn btn-secondary btn-sm" style="margin-top: 10px;" onclick="event.stopPropagation(); deleteTemplate(${i})">–£–¥–∞–ª–∏—Ç—å</button></div>`).join('');
        }

        function saveAsTemplate() { if (!lastResult) { alert('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞'); return; } document.getElementById('templateModal').classList.add('active'); }
        function closeTemplateModal() { document.getElementById('templateModal').classList.remove('active'); document.getElementById('templateName').value = ''; document.getElementById('templateDesc').value = ''; document.getElementById('templateTags').value = ''; }

        function confirmSaveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            templates.push({ name, description: document.getElementById('templateDesc').value.trim(), tags: document.getElementById('templateTags').value.trim().split(',').map(t => t.trim()).filter(t => t), text: lastResult, model: lastUsedModel, date: new Date().toISOString() });
            localStorage.setItem('argumentTemplates', JSON.stringify(templates));
            closeTemplateModal(); loadTemplates(); alert('–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
        }

        function useTemplate(index) {
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            if (templates[index]) {
                lastResult = templates[index].text;
                lastUsedModel = templates[index].model;
                switchMainTab('generator');
                const output = document.getElementById('output');
                output.innerHTML = formatOutputHtml(templates[index].text);
                output.classList.remove('output-empty');
                output.style.display = 'block';
                document.getElementById('actionButtons').style.display = 'flex';
                document.getElementById('modelBadge').textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                document.getElementById('outputBadges').style.display = 'block';
            }
        }

        function deleteTemplate(index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?')) return;
            const templates = JSON.parse(localStorage.getItem('argumentTemplates') || '[]');
            templates.splice(index, 1);
            localStorage.setItem('argumentTemplates', JSON.stringify(templates));
            loadTemplates();
        }

        let calcPayments = [];
        let lastCalcData = null; // –•—Ä–∞–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—á—ë—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

        function addPayment() {
            const id = Date.now();
            calcPayments.push(id);
            const list = document.getElementById('paymentsList');
            const div = document.createElement('div');
            div.className = 'payment-row';
            div.id = `payment-${id}`;
            div.innerHTML = `
                <div>
                    <label>–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞</label>
                    <input type="date" id="payment-date-${id}">
                </div>
                <div>
                    <label>–°—É–º–º–∞ (—Ä—É–±.)</label>
                    <input type="number" id="payment-amount-${id}" placeholder="100000">
                </div>
                <button type="button" class="remove-payment" onclick="removePayment(${id})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
            `;
            list.appendChild(div);
        }

        function removePayment(id) {
            calcPayments = calcPayments.filter(p => p !== id);
            const el = document.getElementById(`payment-${id}`);
            if (el) el.remove();
        }

        function getRate() {
            const rateType = document.getElementById('calcRateType').value;
            const keyRate = currentRate ? currentRate.key_rate : 21;
            let yearRate, rateLabel;

            switch (rateType) {
                case '395': yearRate = keyRate; rateLabel = `${yearRate}% –≥–æ–¥–æ–≤—ã—Ö (–∫–ª—é—á. —Å—Ç–∞–≤–∫–∞)`; break;
                case 'double': yearRate = keyRate * 2; rateLabel = `${yearRate}% –≥–æ–¥–æ–≤—ã—Ö (2√ó –∫–ª—é—á.)`; break;
                case '01': yearRate = 36.5; rateLabel = '0.1% –≤ –¥–µ–Ω—å (36.5% –≥–æ–¥.)'; break;
                case '05': yearRate = 182.5; rateLabel = '0.5% –≤ –¥–µ–Ω—å (182.5% –≥–æ–¥.)'; break;
                case '1': yearRate = 365; rateLabel = '1% –≤ –¥–µ–Ω—å (365% –≥–æ–¥.)'; break;
                default:
                    yearRate = parseFloat(document.getElementById('calcCustomRate').value) || 0;
                    rateLabel = `${yearRate}% –≥–æ–¥–æ–≤—ã—Ö`;
            }
            return { yearRate, rateLabel, keyRate };
        }

        function showCalcError(msg) {
            const el = document.getElementById('calcError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function hideCalcError() {
            document.getElementById('calcError').style.display = 'none';
        }

        function calculatePenalty() {
            hideCalcError();
            const { yearRate, rateLabel, keyRate } = getRate();

            if (yearRate <= 0) { showCalcError('–£–∫–∞–∂–∏—Ç–µ —Å—Ç–∞–≤–∫—É –Ω–µ—É—Å—Ç–æ–π–∫–∏'); return; }

            const totalDebt = parseFloat(document.getElementById('calcDebt').value) || 0;
            const startDate = document.getElementById('calcStartDate').value;
            const endDate = document.getElementById('calcEndDate').value;

            if (!totalDebt) { showCalcError('–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É –¥–æ–ª–≥–∞'); return; }
            if (!startDate) { showCalcError('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏'); return; }
            if (!endDate) { showCalcError('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è'); return; }
            if (new Date(endDate) <= new Date(startDate)) { showCalcError('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞'); return; }

            // –°–æ–±–∏—Ä–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏
            const payments = [];
            for (const id of calcPayments) {
                const date = document.getElementById(`payment-date-${id}`).value;
                const amount = parseFloat(document.getElementById(`payment-amount-${id}`).value) || 0;
                if (date && amount > 0) {
                    payments.push({ date: new Date(date), amount });
                }
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –¥–∞—Ç–µ
            payments.sort((a, b) => a.date - b.date);

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–µ—É—Å—Ç–æ–π–∫—É –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
            const results = [];
            let remainingDebt = totalDebt;
            let currentDate = new Date(startDate);
            const finalDate = new Date(endDate);
            let totalPenalty = 0;
            let totalPenalty333 = 0;

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø–µ—Ä–∏–æ–¥ –¥–æ –ø–ª–∞—Ç–µ–∂–∞
            for (const payment of payments) {
                if (payment.date <= currentDate) continue; // –ü–ª–∞—Ç—ë–∂ –¥–æ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∏
                if (payment.date > finalDate) break; // –ü–ª–∞—Ç—ë–∂ –ø–æ—Å–ª–µ –¥–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞

                const days = Math.ceil((payment.date - currentDate) / (1000 * 60 * 60 * 24));
                if (days > 0 && remainingDebt > 0) {
                    const penalty = remainingDebt * (yearRate / 100) * (days / 365);
                    const penalty333 = remainingDebt * (keyRate * 2 / 100) * (days / 365);
                    results.push({
                        debt: remainingDebt,
                        startDate: currentDate.toISOString().split('T')[0],
                        endDate: payment.date.toISOString().split('T')[0],
                        days,
                        penalty,
                        penalty333,
                        paymentAmount: payment.amount
                    });
                    totalPenalty += penalty;
                    totalPenalty333 += penalty333;
                }

                remainingDebt = Math.max(0, remainingDebt - payment.amount);
                currentDate = new Date(payment.date);
            }

            // –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥ (–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –¥–æ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è)
            if (currentDate < finalDate && remainingDebt > 0) {
                const days = Math.ceil((finalDate - currentDate) / (1000 * 60 * 60 * 24));
                const penalty = remainingDebt * (yearRate / 100) * (days / 365);
                const penalty333 = remainingDebt * (keyRate * 2 / 100) * (days / 365);
                results.push({
                    debt: remainingDebt,
                    startDate: currentDate.toISOString().split('T')[0],
                    endDate: endDate,
                    days,
                    penalty,
                    penalty333,
                    paymentAmount: null
                });
                totalPenalty += penalty;
                totalPenalty333 += penalty333;
            }

            // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–∏–æ–¥–æ–≤ (–Ω–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–∫–∏)
            if (results.length === 0) {
                showCalcError('–ù–µ—Ç –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –Ω–µ—É—Å—Ç–æ–π–∫–∏');
                return;
            }

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const detailsHtml = results.map((r, i) => `
                <div style="background: #F4F7F9; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="color: #1E3A5F; font-weight: 500;">–î–æ–ª–≥: ${r.debt.toLocaleString('ru-RU')} ‚ÇΩ</span>
                        <span style="color: #1E3A5F; font-weight: 600;">${r.penalty.toLocaleString('ru-RU', {maximumFractionDigits: 2})} ‚ÇΩ</span>
                    </div>
                    <div style="color: #8899A6; font-size: 11px;">
                        ${formatDate(r.startDate)} ‚Äî ${formatDate(r.endDate)} (${r.days} –¥–Ω.)
                    </div>
                    ${r.paymentAmount ? `<div style="color: #48BB78; font-size: 11px; margin-top: 4px;">‚Üì –ü–ª–∞—Ç—ë–∂: ${r.paymentAmount.toLocaleString('ru-RU')} ‚ÇΩ</div>` : ''}
                </div>
            `).join('');

            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const summaryHtml = `
                <div style="background: #E8F5E9; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px;">
                    <div>–ù–∞—á–∞–ª—å–Ω—ã–π –¥–æ–ª–≥: <b>${totalDebt.toLocaleString('ru-RU')} ‚ÇΩ</b></div>
                    <div>–û–ø–ª–∞—á–µ–Ω–æ: <b>${totalPaid.toLocaleString('ru-RU')} ‚ÇΩ</b></div>
                    <div>–û—Å—Ç–∞—Ç–æ–∫: <b>${(totalDebt - totalPaid).toLocaleString('ru-RU')} ‚ÇΩ</b></div>
                </div>
            `;

            document.getElementById('calcResultDetails').innerHTML = `
                <div class="calc-result-item" style="border-bottom: none; padding-bottom: 5px;">
                    <span class="label">–°—Ç–∞–≤–∫–∞</span>
                    <span class="value">${rateLabel}</span>
                </div>
                ${summaryHtml}
                <div style="font-size: 12px; font-weight: 500; color: #1E3A5F; margin: 10px 0 5px;">–†–∞—Å—á—ë—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º:</div>
                ${detailsHtml}
            `;

            document.getElementById('resultPenalty').textContent = totalPenalty.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('result333').textContent = totalPenalty333.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('calcResult').style.display = 'block';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            lastCalcData = {
                totalDebt,
                startDate,
                endDate,
                rateLabel,
                results,
                totalPenalty,
                totalPenalty333,
                totalPaid: payments.reduce((sum, p) => sum + p.amount, 0),
                remainingDebt: totalDebt - payments.reduce((sum, p) => sum + p.amount, 0)
            };
        }

        function toggleCustomRate() {
            const rateType = document.getElementById('calcRateType').value;
            document.getElementById('customRateRow').style.display = rateType === 'contract' ? 'block' : 'none';
        }

        function clearCalculator() {
            document.getElementById('calcDebt').value = '';
            document.getElementById('calcStartDate').value = '';
            document.getElementById('calcEndDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('calcRateType').value = 'contract';
            document.getElementById('calcCustomRate').value = '';
            document.getElementById('customRateRow').style.display = 'block';
            document.getElementById('calcResult').style.display = 'none';
            document.getElementById('paymentsList').innerHTML = '';
            calcPayments = [];
            lastCalcData = null;
            hideCalcError();
        }

        async function downloadCalcDocx() {
            if (!lastCalcData) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç');
                return;
            }

            const { Document, Packer, Paragraph, TextRun, AlignmentType, ImageRun } = docx;
            const data = lastCalcData;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–æ
            let logoData = null;
            try {
                const response = await fetch('/icon-192.png');
                const blob = await response.blob();
                logoData = await blob.arrayBuffer();
            } catch (e) {
                console.warn('Could not load logo:', e);
            }

            const children = [];

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–æ –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (logoData) {
                children.push(
                    new Paragraph({
                        children: [
                            new ImageRun({ data: logoData, transformation: { width: 20, height: 20 }, type: 'png' }),
                            new TextRun({ text: "  " }),
                            new TextRun({ text: "Anti", bold: true, size: 24, color: "1a2744" }),
                            new TextRun({ text: "333", bold: true, size: 24, color: "C9A227" }),
                            new TextRun({ text: ".AI", bold: true, size: 24, color: "1a2744" }),
                        ],
                        spacing: { after: 300 }
                    })
                );
            }

            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            children.push(new Paragraph({
                children: [new TextRun({ text: "–†–ê–°–ß–Å–¢ –ù–ï–£–°–¢–û–ô–ö–ò", bold: true, size: 32, color: "1a2744" })],
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            }));

            // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            children.push(new Paragraph({
                children: [
                    new TextRun({ text: "–°—É–º–º–∞ –¥–æ–ª–≥–∞: ", size: 24 }),
                    new TextRun({ text: data.totalDebt.toLocaleString('ru-RU') + " ‚ÇΩ", bold: true, size: 24 })
                ],
                spacing: { after: 120 }
            }));

            children.push(new Paragraph({
                children: [
                    new TextRun({ text: "–ü–µ—Ä–∏–æ–¥ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: ", size: 24 }),
                    new TextRun({ text: `${formatDate(data.startDate)} ‚Äî ${formatDate(data.endDate)}`, bold: true, size: 24 })
                ],
                spacing: { after: 120 }
            }));

            children.push(new Paragraph({
                children: [
                    new TextRun({ text: "–°—Ç–∞–≤–∫–∞: ", size: 24 }),
                    new TextRun({ text: data.rateLabel, bold: true, size: 24 })
                ],
                spacing: { after: 200 }
            }));

            if (data.totalPaid > 0) {
                children.push(new Paragraph({
                    children: [
                        new TextRun({ text: "–û–ø–ª–∞—á–µ–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ: ", size: 24 }),
                        new TextRun({ text: data.totalPaid.toLocaleString('ru-RU') + " ‚ÇΩ", bold: true, size: 24 })
                    ],
                    spacing: { after: 120 }
                }));
                children.push(new Paragraph({
                    children: [
                        new TextRun({ text: "–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞: ", size: 24 }),
                        new TextRun({ text: data.remainingDebt.toLocaleString('ru-RU') + " ‚ÇΩ", bold: true, size: 24 })
                    ],
                    spacing: { after: 200 }
                }));
            }

            // –†–∞—Å—á—ë—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
            children.push(new Paragraph({
                children: [new TextRun({ text: "–†–∞—Å—á—ë—Ç –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º:", bold: true, size: 26, color: "1a2744" })],
                spacing: { before: 300, after: 200 }
            }));

            for (const r of data.results) {
                children.push(new Paragraph({
                    children: [
                        new TextRun({ text: `${formatDate(r.startDate)} ‚Äî ${formatDate(r.endDate)} (${r.days} –¥–Ω.)`, size: 22 }),
                    ],
                    spacing: { after: 60 }
                }));
                children.push(new Paragraph({
                    children: [
                        new TextRun({ text: `–î–æ–ª–≥: ${r.debt.toLocaleString('ru-RU')} ‚ÇΩ ‚Üí –ù–µ—É—Å—Ç–æ–π–∫–∞: `, size: 22 }),
                        new TextRun({ text: r.penalty.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + " ‚ÇΩ", bold: true, size: 22 })
                    ],
                    spacing: { after: r.paymentAmount ? 60 : 200 }
                }));
                if (r.paymentAmount) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: `‚Üì –ü–ª–∞—Ç—ë–∂: ${r.paymentAmount.toLocaleString('ru-RU')} ‚ÇΩ`, size: 22, color: "48BB78" })],
                        spacing: { after: 200 }
                    }));
                }
            }

            // –ò—Ç–æ–≥–æ
            children.push(new Paragraph({
                children: [
                    new TextRun({ text: "–ò–¢–û–ì–û –ù–ï–£–°–¢–û–ô–ö–ê: ", bold: true, size: 28, color: "1a2744" }),
                    new TextRun({ text: data.totalPenalty.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + " ‚ÇΩ", bold: true, size: 28, color: "C9A227" })
                ],
                spacing: { before: 300, after: 120 }
            }));

            children.push(new Paragraph({
                children: [
                    new TextRun({ text: "–°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ —Å—Ç. 333 –ì–ö –†–§ (–¥–æ 2x –∫–ª—é—á.): ", size: 24 }),
                    new TextRun({ text: data.totalPenalty333.toLocaleString('ru-RU', {maximumFractionDigits: 2}) + " ‚ÇΩ", bold: true, size: 24 })
                ],
                spacing: { after: 200 }
            }));

            const doc = new Document({
                sections: [{
                    properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } },
                    children
                }]
            });

            const fileName = `–†–∞—Å—á—ë—Ç_–Ω–µ—É—Å—Ç–æ–π–∫–∏_${new Date().toISOString().split('T')[0]}.docx`;
            saveAs(await Packer.toBlob(doc), fileName);
        }

        function updateStatsAfterGeneration(model, time) {
            stats.total++;
            stats.times.push(time);
            if (stats.times.length > 100) stats.times.shift();
            stats.models[model] = (stats.models[model] || 0) + 1;
            localStorage.setItem('generationStats', JSON.stringify(stats));
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalGenerations').textContent = stats.total;
            if (stats.times.length > 0) document.getElementById('avgTime').textContent = (stats.times.reduce((a, b) => a + b, 0) / stats.times.length).toFixed(1) + ' —Å–µ–∫.';
            if (Object.keys(stats.models).length > 0) document.getElementById('topModel').textContent = MODEL_NAMES[Object.entries(stats.models).sort((a, b) => b[1] - a[1])[0][0]] || '-';
        }

        function saveDraft() {
            const draft = { claimText: document.getElementById('claimText').value, responseText: document.getElementById('responseText').value, userComments: document.getElementById('userComments').value, selectedModel };
            if (draft.claimText || draft.responseText || draft.userComments) localStorage.setItem('draft', JSON.stringify(draft));
        }

        function loadDraft() {
            const draft = JSON.parse(localStorage.getItem('draft') || 'null');
            if (draft) {
                document.getElementById('claimText').value = draft.claimText || '';
                document.getElementById('responseText').value = draft.responseText || '';
                document.getElementById('userComments').value = draft.userComments || '';
                if (draft.selectedModel) { selectedModel = draft.selectedModel; document.querySelectorAll('.model-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.model === selectedModel)); }
            }
        }

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button if not already installed
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-info btn-sm';
            installBtn.innerHTML = 'üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            installBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                }
            };
            document.body.appendChild(installBtn);

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installBtn.parentNode) {
                    installBtn.style.transition = 'opacity 0.5s';
                    installBtn.style.opacity = '0';
                    setTimeout(() => installBtn.remove(), 500);
                }
            }, 10000);
        });

        // Handle app installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
