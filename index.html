<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ç–∏–≤ —Å—Ç. 333 –ì–ö –†–§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(145deg, #E8EEF2 0%, #D4DEE7 50%, #C5D3E0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FAFBFC;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(30, 58, 95, 0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1E3A5F 0%, #2C4A6E 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #C9A227, #E8C547, #C9A227);
        }

        .header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; }
        .header p { font-size: 14px; opacity: 0.85; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 600px;
        }

        .form-section {
            padding: 25px;
            background: #F4F7F9;
            border-right: 1px solid #E1E8ED;
            overflow-y: auto;
            max-height: 80vh;
        }

        .output-section {
            padding: 25px;
            background: #FAFBFC;
            overflow-y: auto;
            max-height: 80vh;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #C9A227;
        }

        .document-block {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .document-block h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 12px;
        }

        .document-block h3 .required { color: #C9A227; }
        .document-block h3 .optional { font-weight: 400; font-size: 11px; color: #8899A6; }

        .input-tabs { display: flex; gap: 8px; margin-bottom: 12px; }

        .tab-btn {
            padding: 6px 12px;
            border: 1px solid #E1E8ED;
            background: #F4F7F9;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            color: #4A5568;
        }

        .tab-btn.active {
            background: #1E3A5F;
            color: white;
            border-color: #1E3A5F;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .file-upload {
            border: 2px dashed #CBD5E0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #FAFBFC;
        }

        .file-upload:hover { border-color: #C9A227; background: #FFFDF5; }
        .file-upload.has-file { border-color: #48BB78; background: #F0FFF4; }
        .file-upload input[type="file"] { display: none; }
        .file-upload .upload-icon { font-size: 24px; margin-bottom: 8px; }
        .file-upload .upload-text { font-size: 12px; color: #8899A6; }
        .file-upload .file-name { font-size: 12px; color: #48BB78; font-weight: 600; margin-top: 8px; }

        textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E1E8ED;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        textarea:focus, select:focus { outline: none; border-color: #C9A227; }
        textarea::placeholder { color: #A0AEC0; }

        .model-selector {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .model-selector h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1E3A5F;
            margin-bottom: 12px;
        }

        .model-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .model-option {
            padding: 10px;
            border: 2px solid #E1E8ED;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .model-option:hover { border-color: #C9A227; }
        .model-option.selected { border-color: #1E3A5F; background: #F0F5FF; }
        .model-option .model-name { font-weight: 600; font-size: 13px; color: #1E3A5F; }
        .model-option .model-desc { font-size: 11px; color: #8899A6; margin-top: 4px; }

        .rates-info {
            background: #F0F5FF;
            border: 1px solid #C3D4E8;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .rates-info h4 { font-size: 13px; color: #1E3A5F; margin-bottom: 8px; }

        .button-group { display: flex; gap: 10px; margin-top: 15px; }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1E3A5F 0%, #2C4A6E 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #E8EEF2; color: #4A5568; }
        .btn-secondary:hover { background: #D4DEE7; }

        .btn-success { background: #48BB78; color: white; }
        .btn-success:hover { background: #38A169; }

        .btn-warning { background: #ED8936; color: white; }
        .btn-warning:hover { background: #DD6B20; }

        .output-box {
            background: white;
            border: 1px solid #E1E8ED;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            font-size: 14px;
            line-height: 1.7;
            color: #2D3748;
            white-space: pre-wrap;
        }

        .output-empty { color: #A0AEC0; font-style: italic; text-align: center; padding-top: 80px; }

        .model-badge {
            display: inline-block;
            background: #E8EEF2;
            color: #1E3A5F;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .action-buttons .btn { flex: 1; min-width: 120px; }

        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #E1E8ED;
            border-top: 3px solid #C9A227;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .loading-text { color: #4A5568; font-size: 14px; }

        .error-box {
            background: #FFF5F5;
            border: 1px solid #FC8181;
            border-radius: 8px;
            padding: 12px;
            color: #C53030;
            margin-bottom: 15px;
            display: none;
        }

        .error-box.active { display: block; }

        .history-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #E1E8ED;
        }

        .history-section h4 { font-size: 13px; color: #1E3A5F; margin-bottom: 10px; }

        .history-item {
            background: #F4F7F9;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .history-item:hover { background: #E8EEF2; }
        .history-item .date { color: #8899A6; font-size: 11px; }
        .history-item .preview { color: #4A5568; margin-top: 4px; }

        .footer {
            background: #F4F7F9;
            padding: 12px;
            text-align: center;
            border-top: 1px solid #E1E8ED;
        }

        .footer .author { font-size: 11px; color: #8899A6; }

        @media (max-width: 968px) {
            .main-content { grid-template-columns: 1fr; }
            .form-section, .output-section { max-height: none; border-right: none; }
            .form-section { border-bottom: 1px solid #E1E8ED; }
            .model-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ—Ç–∏–≤ —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–µ—É—Å—Ç–æ–π–∫–∏</h1>
            <p>–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Å—Ç. 333 –ì–ö –†–§</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2 class="section-title">–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>

                <div class="document-block">
                    <h3>–ò—Å–∫ –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –Ω–µ—É—Å—Ç–æ–π–∫–∏ <span class="required">*</span></h3>
                    <div class="input-tabs">
                        <button class="tab-btn active" onclick="switchTab('claim', 'file', this)">–§–∞–π–ª</button>
                        <button class="tab-btn" onclick="switchTab('claim', 'text', this)">–¢–µ–∫—Å—Ç</button>
                    </div>
                    <div id="claim-file-tab" class="tab-content active">
                        <div class="file-upload" onclick="document.getElementById('claimFile').click()">
                            <input type="file" id="claimFile" accept=".txt,.rtf,.docx,.doc" onchange="handleFileSelect(this, 'claim')">
                            <div class="upload-icon">üìÑ</div>
                            <div class="upload-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (.docx, .txt, .rtf)</div>
                            <div id="claim-file-name" class="file-name"></div>
                        </div>
                    </div>
                    <div id="claim-text-tab" class="tab-content">
                        <textarea id="claimText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏—Å–∫–∞..."></textarea>
                    </div>
                </div>

                <div class="document-block">
                    <h3>–û—Ç–∑—ã–≤ –æ—Ç–≤–µ—Ç—á–∏–∫–∞ <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></h3>
                    <div class="input-tabs">
                        <button class="tab-btn active" onclick="switchTab('response', 'file', this)">–§–∞–π–ª</button>
                        <button class="tab-btn" onclick="switchTab('response', 'text', this)">–¢–µ–∫—Å—Ç</button>
                    </div>
                    <div id="response-file-tab" class="tab-content active">
                        <div class="file-upload" onclick="document.getElementById('responseFile').click()">
                            <input type="file" id="responseFile" accept=".txt,.rtf,.docx,.doc" onchange="handleFileSelect(this, 'response')">
                            <div class="upload-icon">üìã</div>
                            <div class="upload-text">–•–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ —Å–Ω–∏–∂–µ–Ω–∏–∏ (.docx, .txt)</div>
                            <div id="response-file-name" class="file-name"></div>
                        </div>
                    </div>
                    <div id="response-text-tab" class="tab-content">
                        <textarea id="responseText" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞..."></textarea>
                    </div>
                </div>

                <div class="document-block">
                    <h3>–ü–æ—è—Å–Ω–µ–Ω–∏—è <span class="optional">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></h3>
                    <textarea id="userComments" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –∞–∫—Ü–µ–Ω—Ç—ã, –ø–æ–∂–µ–ª–∞–Ω–∏—è..." style="min-height: 80px;"></textarea>
                </div>

                <div class="model-selector">
                    <h3>–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏</h3>
                    <div class="model-options">
                        <div class="model-option selected" data-model="gemini-2.5-pro" onclick="selectModel(this)">
                            <div class="model-name">Gemini 2.5 Pro</div>
                            <div class="model-desc">Google, –±—ã—Å—Ç—Ä—ã–π</div>
                        </div>
                        <div class="model-option" data-model="claude-sonnet-4-20250514" onclick="selectModel(this)">
                            <div class="model-name">Claude Sonnet 4</div>
                            <div class="model-desc">Anthropic, –±–∞–ª–∞–Ω—Å</div>
                        </div>
                        <div class="model-option" data-model="claude-opus-4-5-20251101" onclick="selectModel(this)">
                            <div class="model-name">Claude Opus 4.5</div>
                            <div class="model-desc">Anthropic, –º–æ—â–Ω—ã–π</div>
                        </div>
                    </div>
                </div>

                <div class="rates-info">
                    <h4>üìä –ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§</h4>
                    <div id="ratesContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>

                <div class="button-group">
                    <button id="analyzeBtn" class="btn btn-primary" onclick="generateArguments()">
                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button class="btn btn-secondary" onclick="clearForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>

                <div class="history-section" id="historySection" style="display: none;">
                    <h4>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h4>
                    <div id="historyList"></div>
                </div>
            </div>

            <div class="output-section">
                <h2 class="section-title">–ê—Ä–≥—É–º–µ–Ω—Ç—ã –ø—Ä–æ—Ç–∏–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç. 333 –ì–ö –†–§</h2>

                <div id="errorBox" class="error-box"></div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <div class="loading-text" id="loadingText">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤...</div>
                </div>

                <div id="modelBadge" class="model-badge" style="display: none;"></div>

                <div id="output" class="output-box output-empty">
                    –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª
                </div>

                <div id="actionButtons" class="action-buttons" style="display: none;">
                    <button class="btn btn-primary" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-success" onclick="downloadDocx()">üì• DOCX</button>
                    <button class="btn btn-warning" onclick="regenerateWithDifferentModel()">üîÑ –î—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="author">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ö–∏—Ä–∏–ª–ª –¢—Ä—É–±–∏—Ü—ã–Ω</div>
        </div>
    </div>

    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å DOCX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        let cachedRates = [];
        let currentRate = null;
        let lastResult = '';
        let selectedModel = 'gemini-2.5-pro';
        let lastUsedModel = '';
        let lastInputData = null;

        const MODEL_NAMES = {
            'gemini-2.5-pro': 'Gemini 2.5 Pro',
            'claude-sonnet-4-20250514': 'Claude Sonnet 4',
            'claude-opus-4-5-20251101': 'Claude Opus 4.5'
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadRates();
            loadHistory();
        });

        function selectModel(el) {
            document.querySelectorAll('.model-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedModel = el.dataset.model;
        }

        async function loadRates() {
            try {
                const response = await fetch('/api/rates');
                if (response.ok) {
                    const data = await response.json();
                    cachedRates = data.history || [];
                    currentRate = data.current;
                    const container = document.getElementById('ratesContainer');

                    if (currentRate) {
                        let html = `<div style="font-size: 24px; font-weight: 700; color: #1E3A5F;">${currentRate.key_rate}%</div>
                            <div style="font-size: 11px; color: #8899A6;">—Å ${formatDate(currentRate.date_from)}</div>`;

                        if (cachedRates.length > 1) {
                            html += `<details style="margin-top: 8px;">
                                <summary style="font-size: 11px; color: #8899A6; cursor: pointer;">–ò—Å—Ç–æ—Ä–∏—è</summary>
                                <div style="margin-top: 6px; font-size: 11px; color: #4A5568;">
                                    ${cachedRates.slice(-5).reverse().map(r =>
                                        `<div>—Å ${formatDate(r.date_from)}: ${r.key_rate}%</div>`
                                    ).join('')}
                                </div>
                            </details>`;
                        }
                        container.innerHTML = html;
                    }
                }
            } catch (e) {
                document.getElementById('ratesContainer').innerHTML = '<div style="color: #C53030;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        function formatDate(isoDate) {
            return new Date(isoDate).toLocaleDateString('ru-RU');
        }

        function switchTab(docType, tabType, btn) {
            btn.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`${docType}-file-tab`).classList.remove('active');
            document.getElementById(`${docType}-text-tab`).classList.remove('active');
            document.getElementById(`${docType}-${tabType}-tab`).classList.add('active');
        }

        function handleFileSelect(input, docType) {
            const fileNameEl = document.getElementById(`${docType}-file-name`);
            const uploadBox = input.parentElement;
            if (input.files && input.files[0]) {
                fileNameEl.textContent = '‚úì ' + input.files[0].name;
                uploadBox.classList.add('has-file');
            } else {
                fileNameEl.textContent = '';
                uploadBox.classList.remove('has-file');
            }
        }

        async function readFileAsText(file) {
            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const arrayBuffer = e.target.result;
                            const result = await mammoth.extractRawText({ arrayBuffer });
                            resolve(result.value);
                        } catch (err) {
                            reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è DOCX: ' + err.message));
                        }
                    };
                    reader.onerror = (e) => reject(e);
                    reader.readAsArrayBuffer(file);
                });
            }

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function generateArguments(useModel = null) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorBox');
            const actionButtons = document.getElementById('actionButtons');
            const modelBadge = document.getElementById('modelBadge');

            const modelToUse = useModel || selectedModel;

            const claimFile = document.getElementById('claimFile').files[0];
            const claimText = document.getElementById('claimText').value;
            const responseFile = document.getElementById('responseFile').files[0];
            const responseText = document.getElementById('responseText').value;
            const userComments = document.getElementById('userComments').value;

            let finalClaimText = claimText;
            let finalResponseText = responseText;

            try {
                if (claimFile) finalClaimText = await readFileAsText(claimFile);
                if (responseFile) finalResponseText = await readFileAsText(responseFile);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                return;
            }

            if (!finalClaimText.trim()) {
                alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å–∫ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ —Ç–µ–∫—Å—Ç');
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            lastInputData = {
                claim_text: finalClaimText,
                response_text: finalResponseText,
                user_comments: userComments
            };

            analyzeBtn.disabled = true;
            loading.classList.add('active');
            loadingText.textContent = `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è (${MODEL_NAMES[modelToUse]})...`;
            output.style.display = 'none';
            errorBox.classList.remove('active');
            actionButtons.style.display = 'none';
            modelBadge.style.display = 'none';

            try {
                let ratesInfo = '–°—Ç–∞–≤–∫–∞ –¶–ë –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                if (currentRate) {
                    ratesInfo = `–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§: ${currentRate.key_rate}% (—Å ${currentRate.date_from})`;
                }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        claim_text: finalClaimText,
                        response_text: finalResponseText,
                        other_documents: '',
                        user_comments: userComments,
                        rates_info: ratesInfo,
                        model: modelToUse
                    })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞');

                lastResult = result.arguments_text;
                lastUsedModel = result.model_used || modelToUse;

                modelBadge.textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                modelBadge.style.display = 'inline-block';

                output.textContent = result.arguments_text;
                output.classList.remove('output-empty');
                output.style.display = 'block';

                actionButtons.style.display = 'flex';
                saveToHistory(result.arguments_text, lastUsedModel);

            } catch (error) {
                errorBox.textContent = '‚ùå ' + error.message;
                errorBox.classList.add('active');
                output.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        function regenerateWithDifferentModel() {
            if (!lastInputData) {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã');
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
            const models = ['gemini-2.5-pro', 'claude-sonnet-4-20250514', 'claude-opus-4-5-20251101'];
            const currentIndex = models.indexOf(lastUsedModel);
            const nextIndex = (currentIndex + 1) % models.length;
            const nextModel = models[nextIndex];

            // –í—ã–±–∏—Ä–∞–µ–º –µ—ë –≤–∏–∑—É–∞–ª—å–Ω–æ
            document.querySelectorAll('.model-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.model === nextModel);
            });
            selectedModel = nextModel;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å –Ω–æ–≤–æ–π –º–æ–¥–µ–ª—å—é, –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            generateWithSavedData(nextModel);
        }

        async function generateWithSavedData(modelToUse) {
            if (!lastInputData) return;

            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorBox');
            const actionButtons = document.getElementById('actionButtons');
            const modelBadge = document.getElementById('modelBadge');

            analyzeBtn.disabled = true;
            loading.classList.add('active');
            loadingText.textContent = `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è (${MODEL_NAMES[modelToUse]})...`;
            output.style.display = 'none';
            errorBox.classList.remove('active');
            actionButtons.style.display = 'none';

            try {
                let ratesInfo = '–°—Ç–∞–≤–∫–∞ –¶–ë –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                if (currentRate) {
                    ratesInfo = `–¢–µ–∫—É—â–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§: ${currentRate.key_rate}% (—Å ${currentRate.date_from})`;
                }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...lastInputData,
                        other_documents: '',
                        rates_info: ratesInfo,
                        model: modelToUse
                    })
                });

                const result = await response.json();

                if (!response.ok) throw new Error(result.error || '–û—à–∏–±–∫–∞');

                lastResult = result.arguments_text;
                lastUsedModel = result.model_used || modelToUse;

                modelBadge.textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                modelBadge.style.display = 'inline-block';

                output.textContent = result.arguments_text;
                output.classList.remove('output-empty');
                output.style.display = 'block';

                actionButtons.style.display = 'flex';
                saveToHistory(result.arguments_text, lastUsedModel);

            } catch (error) {
                errorBox.textContent = '‚ùå ' + error.message;
                errorBox.classList.add('active');
                output.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        function clearForm() {
            ['claimFile', 'responseFile'].forEach(id => document.getElementById(id).value = '');
            ['claim', 'response'].forEach(type => {
                document.getElementById(`${type}-file-name`).textContent = '';
                const upload = document.querySelector(`#${type}-file-tab .file-upload`);
                if (upload) upload.classList.remove('has-file');
            });
            ['claimText', 'responseText', 'userComments'].forEach(id => document.getElementById(id).value = '');

            const output = document.getElementById('output');
            output.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª';
            output.classList.add('output-empty');
            document.getElementById('errorBox').classList.remove('active');
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('modelBadge').style.display = 'none';
            lastInputData = null;
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(lastResult).then(() => {
                alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
            });
        }

        async function downloadDocx() {
            const { Document, Packer, Paragraph, TextRun, AlignmentType } = docx;

            const lines = lastResult.split('\n');
            const children = [];

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) {
                    children.push(new Paragraph({ text: '' }));
                    continue;
                }

                const isMainHeading = /^\d+\.\s+[–ê-–Ø–ÅA-Z\s]+$/.test(trimmed);
                const isSubHeading = /^\d+\.\d+\.?\s+/.test(trimmed);

                if (isMainHeading) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: trimmed, bold: true, size: 26, color: "1a3a6e" })],
                        spacing: { before: 360, after: 180 },
                        alignment: AlignmentType.LEFT
                    }));
                } else if (isSubHeading) {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: trimmed, bold: true, size: 24, color: "1a3a6e" })],
                        spacing: { before: 240, after: 120 }
                    }));
                } else {
                    children.push(new Paragraph({
                        children: [new TextRun({ text: trimmed, size: 24 })],
                        spacing: { after: 120 },
                        alignment: AlignmentType.JUSTIFIED
                    }));
                }
            }

            const doc = new Document({
                sections: [{
                    properties: {
                        page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } }
                    },
                    children: children
                }]
            });

            const blob = await Packer.toBlob(doc);
            saveAs(blob, 'arguments_333.docx');
        }

        function saveToHistory(fullText, model) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const resultPreview = fullText.substring(0, 100).replace(/[\r\n]+/g, ' ');
            history.unshift({
                date: new Date().toISOString(),
                preview: resultPreview,
                text: fullText,
                model: model
            });
            if (history.length > 10) history.pop();
            localStorage.setItem('argumentsHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            const section = document.getElementById('historySection');
            const list = document.getElementById('historyList');

            if (history.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = history.map((item, i) => `
                <div class="history-item" onclick="loadFromHistory(${i})">
                    <div class="date">${formatDate(item.date)} ${item.model ? '‚Ä¢ ' + (MODEL_NAMES[item.model] || item.model) : ''}</div>
                    <div class="preview">${item.preview}...</div>
                </div>
            `).join('');
        }

        function loadFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('argumentsHistory') || '[]');
            if (history[index]) {
                lastResult = history[index].text;
                lastUsedModel = history[index].model || '';
                document.getElementById('output').textContent = history[index].text;
                document.getElementById('output').classList.remove('output-empty');
                document.getElementById('output').style.display = 'block';
                document.getElementById('actionButtons').style.display = 'flex';

                const modelBadge = document.getElementById('modelBadge');
                if (lastUsedModel) {
                    modelBadge.textContent = MODEL_NAMES[lastUsedModel] || lastUsedModel;
                    modelBadge.style.display = 'inline-block';
                }
            }
        }
    </script>
</body>
</html>
